# Analysis: RST-20251212-381209A4 - ICPMP Scheme P Issue

## Executive Summary

**Problem**: ICPMP calculated 21 employees for Scheme P requirement, but demand slots were not fully met.

**Root Cause**: ICPMP's capacity calculation is **scheme-agnostic**. It doesn't account for Scheme P weekly hour constraints (C6), leading to significant underestimation of required employees.

**Impact**: 
- Current calculation: 21 employees (based on 5 work days/cycle from pattern)
- Correct calculation: **~25 employees** (based on 3 days/week Scheme P limit with 9h shifts)
- **Gap: 4 employees SHORT** (19% underestimation)

---

## Issue Breakdown

### Layer 1: ICPMP Calculation Formula (scheme-agnostic)

**Current Logic** (`context/engine/config_optimizer_v3.py`):
```python
pattern_based_minimum = ceil(headcount × cycle_length ÷ work_days_per_cycle)
# For DDDDDOO with headcount=15:
# ceil(15 × 7 ÷ 5) = ceil(21) = 21 employees
```

**Problem**: Uses pattern's work days (5) without considering scheme constraints.

---

### Layer 2: Shift Duration vs C6 Weekly Limits

**C6 Constraint** (`context/constraints/C6_parttimer_limits.py`):
- Scheme P working ≤4 days/week: **Max 34.98h/week**
- Scheme P working >4 days/week: **Max 29.98h/week**

**Test Case Reality**:
- Shift duration: **9 hours** (09:00-18:00)
- Pattern DDDDDOO: 5 consecutive work days

**Critical Conflict**:
```
Scenario 1: 4 days × 9h = 36h > 34.98h ❌ VIOLATES C6!
Scenario 2: 3 days × 9h = 27h < 34.98h ✓ OK
Scenario 3: 5 days × 9h = 45h > 29.98h ❌ SEVERE VIOLATION!
```

**Conclusion**: Scheme P with 9h shifts can only work **MAX 3 days/week**.

---

### Layer 3: Pattern Feasibility

**Pattern DDDDDOO Requirements**:
- 5 consecutive work days (DDDDD)
- 2 off days (OO)
- Cycle: 7 days

**Scheme P Reality**:
- Max 3 days/week with 9h shifts
- Cannot work 5 consecutive days

**⚠️ FUNDAMENTAL INCOMPATIBILITY**: Pattern DDDDDOO is **IMPOSSIBLE** for Scheme P + 9h shifts.

---

## Detailed Calculations

### Current ICPMP Assumption
```
Pattern DDDDDOO: 5 work days / 7 cycle (71.4% utilization)
Planning period: 31 days = 4.4 cycles
Expected work days/employee: 4.4 × 5 = 22.1 days
Expected hours/employee: 22.1 × 9h = 199h

Result: 21 employees calculated
```

### Scheme P Reality (C6 Constraint)
```
Max work days/week with 9h shifts: 3 days
Planning period: 31 days = 4.4 weeks
Max work days/employee: 4.4 × 3 = 13.3 days
Max hours/employee: 13.3 × 9h = 119.7h

Capacity check:
  50 employees × 13.3 days = 664 employee-days available
  Required: ~332 employee-days (15 headcount × 22.1 days avg)
  
Correct calculation:
  Required employees: ceil(332 ÷ 13.3) = ceil(24.96) = 25 employees

Result: 25 employees needed (not 21!)
```

### Gap Analysis
```
ICPMP calculated: 21 employees
Correct for Scheme P: 25 employees
Shortfall: 4 employees (19% underestimation)

Per-employee difference:
  ICPMP assumes: 22.1 work days/employee
  Reality allows: 13.3 work days/employee
  Difference: 8.8 days less capacity per employee (40% overestimation)
```

---

## Solutions

### Option A: Reduce Shift Duration to 8h ⭐ RECOMMENDED
**Change**: 09:00-18:00 → 09:00-17:00 (8h instead of 9h)

**Validation**:
```
4 days × 8h = 32h < 34.98h ✓ OK (within C6 limit for ≤4 days)
Pattern DDDDOOO (4 work, 3 rest) becomes feasible
```

**ICPMP Calculation**:
```
ceil(15 × 7 ÷ 4) = ceil(26.25) = 27 employees
```

**Benefits**:
- Allows 4 work days/week (vs current 3)
- Pattern adjustment needed: DDDDDOO → DDDDOOO
- More reasonable employee count

---

### Option B: Change Pattern to DDDOOOO (3 work, 4 rest)
**Keep**: 9h shifts
**Change**: Pattern from DDDDDOO to DDDOOOO

**Validation**:
```
3 days × 9h = 27h < 34.98h ✓ OK
Pattern matches Scheme P capacity
```

**ICPMP Calculation**:
```
ceil(15 × 7 ÷ 3) = ceil(35) = 35 employees
```

**Trade-offs**:
- Higher employee count needed (35 vs 27)
- But pattern is feasible with 9h shifts
- More employees idle per cycle

---

### Option C: Mix Employee Schemes
**Keep**: Current pattern and shift duration
**Change**: Add Scheme A employees to pool

**Validation**:
```
Scheme A: Can work 14h/day, up to 6 days/week
Use Scheme A for 5-day pattern cycles
Use Scheme P for shorter coverage periods
```

**Limitation**: Current test case has **ONLY Scheme P employees** (50 total).

---

## ICPMP Enhancement Required

### Problem Statement
ICPMP's `calculate_optimal_with_u_slots()` uses pattern-based work days without considering scheme-specific constraints (C6 weekly hour limits for Scheme P).

### Proposed Enhancement

**File**: `context/engine/config_optimizer_v3.py`

#### 1. Add Scheme-Aware Capacity Calculation
```python
def calculate_scheme_max_days_per_week(scheme: str, shift_duration_hours: float) -> float:
    """
    Calculate maximum work days per week for a given scheme and shift duration.
    
    Args:
        scheme: Employee scheme ('A', 'B', or 'P')
        shift_duration_hours: Gross shift duration in hours
    
    Returns:
        Maximum work days per week (as float for precision)
    """
    if scheme == 'P':
        # C6 constraint for part-time employees:
        # ≤4 days/week: max 34.98h/week
        # >4 days/week: max 29.98h/week
        
        # Conservative approach: use 34.98h limit (applicable for ≤4 days)
        max_hours_per_week = 34.98
        max_days = max_hours_per_week / shift_duration_hours
        
        # Cap at 4 days (C6 threshold)
        return min(max_days, 4.0)
    
    elif scheme in ['A', 'B']:
        # C2 constraint: 44h/week normal hours
        # Plus need at least 1 rest day per week
        max_hours_per_week = 44.0
        max_days = max_hours_per_week / shift_duration_hours
        
        # Cap at 6 days (need 1 rest day)
        return min(max_days, 6.0)
    
    else:
        # Default: assume 44h/week, 6 days max
        return min(44.0 / shift_duration_hours, 6.0)
```

#### 2. Modify Lower Bound Calculation
```python
def calculate_optimal_with_u_slots(
    pattern,
    headcount,
    calendar,
    anchor_date,
    requirement_id,
    scheme='A',  # NEW PARAMETER
    shift_duration_hours=9.0,  # NEW PARAMETER
    ...
):
    """Enhanced to consider scheme-specific capacity constraints."""
    
    # Existing pattern analysis
    work_days_in_pattern = sum(1 for d in pattern if d != 'O')
    pattern_length = len(pattern)
    
    # NEW: Calculate scheme-specific max work days
    scheme_max_days_per_week = calculate_scheme_max_days_per_week(
        scheme, 
        shift_duration_hours
    )
    
    # Convert to per-cycle basis (pattern_length days)
    days_per_cycle = pattern_length / 7.0  # Convert to weeks
    scheme_max_days_per_cycle = scheme_max_days_per_week * days_per_cycle
    
    # Use the MORE RESTRICTIVE of:
    # - Pattern work days (what pattern requires)
    # - Scheme capacity (what employees can do)
    effective_work_capacity = min(work_days_in_pattern, scheme_max_days_per_cycle)
    
    # Recalculate lower bound with scheme constraint
    pattern_based_minimum = math.ceil(
        headcount * pattern_length / effective_work_capacity
    )
    
    # Log for debugging
    logger.info(
        f"Scheme-aware calculation: "
        f"pattern={work_days_in_pattern}/{pattern_length}, "
        f"scheme_max={scheme_max_days_per_cycle:.1f}/{pattern_length}, "
        f"effective={effective_work_capacity:.1f}, "
        f"employees={pattern_based_minimum}"
    )
    
    # Continue with existing logic...
```

#### 3. Add Pattern Feasibility Validation
```python
def validate_pattern_feasibility(
    pattern: list,
    scheme: str,
    shift_duration_hours: float
) -> dict:
    """
    Validate if a pattern is feasible for given scheme and shift duration.
    
    Returns:
        {
            'feasible': bool,
            'max_consecutive_allowed': int,
            'pattern_consecutive_days': int,
            'warnings': list[str]
        }
    """
    warnings = []
    
    # Count consecutive work days in pattern
    max_consecutive = 0
    current_consecutive = 0
    for day in pattern:
        if day != 'O':
            current_consecutive += 1
            max_consecutive = max(max_consecutive, current_consecutive)
        else:
            current_consecutive = 0
    
    # Calculate scheme capacity
    scheme_max_days_per_week = calculate_scheme_max_days_per_week(
        scheme, 
        shift_duration_hours
    )
    
    # Check feasibility
    feasible = max_consecutive <= math.floor(scheme_max_days_per_week)
    
    if not feasible:
        warnings.append(
            f"Pattern requires {max_consecutive} consecutive work days, "
            f"but Scheme {scheme} with {shift_duration_hours}h shifts "
            f"can only work {scheme_max_days_per_week:.1f} days/week max."
        )
        warnings.append(
            f"Suggestion: Reduce consecutive days to {math.floor(scheme_max_days_per_week)} "
            f"or reduce shift duration."
        )
    
    return {
        'feasible': feasible,
        'max_consecutive_allowed': math.floor(scheme_max_days_per_week),
        'pattern_consecutive_days': max_consecutive,
        'warnings': warnings
    }
```

#### 4. Integration Points

**In `src/preprocessing/icpmp_integration.py`**:
```python
def _run_icpmp_for_requirement(self, requirement, employee_pool):
    """Enhanced to pass scheme and shift information to ICPMP."""
    
    # Extract scheme and shift duration
    scheme = requirement.get('scheme', 'A')
    shift_duration = self._calculate_max_shift_duration(requirement)
    
    # Validate pattern feasibility BEFORE running ICPMP
    validation = validate_pattern_feasibility(
        pattern=requirement['workPattern'],
        scheme=scheme,
        shift_duration_hours=shift_duration
    )
    
    if not validation['feasible']:
        for warning in validation['warnings']:
            logger.warning(f"Requirement {requirement['id']}: {warning}")
    
    # Run ICPMP with scheme awareness
    result = calculate_optimal_with_u_slots(
        pattern=requirement['workPattern'],
        headcount=requirement['headcount'],
        calendar=self.calendar,
        anchor_date=self.planning_start,
        requirement_id=requirement['id'],
        scheme=scheme,  # NEW
        shift_duration_hours=shift_duration  # NEW
    )
    
    # Include validation in result
    result['pattern_validation'] = validation
    
    return result
```

---

## Test Results After Enhancement

### Expected Outcomes

**Test Case: RST-20251212-381209A4**
```
Input:
  Scheme: P
  Pattern: DDDDDOO (5 work, 2 rest)
  Shift: 9h (09:00-18:00)
  Headcount: 15

Current ICPMP Result:
  Employees: 21 (❌ insufficient)

After Enhancement:
  Pattern Validation: ❌ INFEASIBLE
    - Pattern requires 5 consecutive days
    - Scheme P + 9h shifts: max 3 days/week
    
  Warning: "Pattern DDDDDOO requires 5 consecutive work days, but Scheme P 
           with 9.0h shifts can only work 3.3 days/week max. Suggestion: 
           Reduce to 3 consecutive days or reduce shift duration to 8h."
  
  Calculated Employees: 25 (based on 3 days/week capacity)
  Recommendation: Change pattern to DDDOOOO or reduce shift to 8h
```

**Modified Test (8h shifts + DDDDOOO pattern)**:
```
Input:
  Scheme: P
  Pattern: DDDDOOO (4 work, 3 rest)
  Shift: 8h (09:00-17:00)
  Headcount: 15

After Enhancement:
  Pattern Validation: ✓ FEASIBLE
    - Pattern requires 4 consecutive days
    - Scheme P + 8h shifts: allows 4 days/week (32h < 34.98h ✓)
  
  Calculated Employees: 27
  Expected Coverage: 100% (with proper rotation offsets)
```

---

## Implementation Checklist

- [ ] Add `calculate_scheme_max_days_per_week()` to config_optimizer_v3.py
- [ ] Add `validate_pattern_feasibility()` to config_optimizer_v3.py
- [ ] Modify `calculate_optimal_with_u_slots()` to accept scheme + shift_duration
- [ ] Update lower bound calculation to use scheme capacity
- [ ] Enhance `_run_icpmp_for_requirement()` in icpmp_integration.py
- [ ] Pass scheme and shift duration from requirement to ICPMP
- [ ] Add pattern feasibility validation before ICPMP calculation
- [ ] Include validation warnings in ICPMP result
- [ ] Add logging for scheme-aware calculations
- [ ] Update unit tests for new parameters
- [ ] Test with RST-20251212-381209A4 (expect 25 employees)
- [ ] Test with modified input (8h + DDDDOOO, expect 27 employees)
- [ ] Document new parameters in config_optimizer_v3.py docstrings
- [ ] Update CONFIGURATION_OPTIMIZER_GUIDE.md

---

## Summary

### Key Insights

1. **ICPMP is scheme-agnostic**: Uses pattern work days without considering scheme constraints
2. **C6 creates hard limits**: Scheme P with 9h shifts can only work 3 days/week (not 5)
3. **Pattern incompatibility**: DDDDDOO (5 consecutive days) impossible for Scheme P + 9h
4. **Underestimation**: 21 employees (ICPMP) vs 25 needed (reality) = 19% gap

### Immediate Action

**For Current Test Case**:
- Change shift: 09:00-18:00 → 09:00-17:00 (8h)
- Change pattern: DDDDDOO → DDDDOOO (4 work, 3 rest)
- Expected ICPMP: 27 employees (up from 21)

**For Production**:
- Implement scheme-aware ICPMP calculation
- Add pattern feasibility validation
- Warn users when pattern incompatible with scheme

### Impact

- **Scheme P requirements**: 15-30% more employees needed than currently calculated
- **Mixed-scheme requirements**: More accurate employee counts per scheme
- **Pattern recommendations**: Can suggest feasible patterns based on scheme + shift duration
- **User experience**: Prevent unsolvable requirements from reaching CP-SAT solver


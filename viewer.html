<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGRS Solver - Output Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            background: #f5f5f5;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #eeeeee;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-divider {
            width: 2px;
            background: linear-gradient(to bottom, transparent, #667eea, transparent);
            margin: 5px 0;
        }

        .section-label {
            padding: 5px 15px;
            font-size: 0.75em;
            font-weight: 600;
            color: #667eea;
            background: #f0f0f0;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-align: center;
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .summary-card.hard {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .summary-card.soft {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .summary-card.overall {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .summary-card.status {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
        }

        .violations-list {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .violations-list h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .violation-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }

        .assignments-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .assignments-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .assignments-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .assignments-table tr:hover {
            background: #f5f5f5;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .employee-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .employee-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .employee-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-item .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .stat-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .warning {
            background: #ffe5e5;
            border-left: 4px solid #f5576c;
            color: #c92a2a;
        }

        .success {
            background: #e5ffe5;
            border-left: 4px solid #43e97b;
            color: #2f7c31;
        }

        .meta-info {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .meta-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .meta-info .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #667eea;
        }

        .info-value {
            color: #333;
            word-break: break-all;
        }

        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .timeline-date {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .timeline-details {
            color: #666;
            font-size: 0.95em;
        }

        /* Calendar View Styles */
        .calendar-view {
            margin-top: 20px;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-toggle button {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .calendar-grid {
            overflow-x: auto;
            margin-top: 20px;
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            border-right: 1px solid #5568d3;
        }

        .calendar-table th:first-child {
            text-align: left;
            min-width: 120px;
        }

        .calendar-table td {
            padding: 15px;
            border: 1px solid #e0e0e0;
            text-align: center;
            vertical-align: top;
            min-width: 150px;
            background: #f9f9f9;
        }

        .calendar-table tr:nth-child(even) td {
            background: #ffffff;
        }

        .calendar-table tr:hover td {
            background: #f0f4ff;
        }

        .assignment-cell {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            line-height: 1.4;
            display: inline-block;
            width: 100%;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .assignment-cell.locked {
            background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
            border: 2px solid #1976d2;
        }

        .assignment-cell.incremental {
            background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%);
            border: 2px solid #f57c00;
            color: #000;
        }

        .assignment-cell.new-employee {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            border: 2px solid #2e7d32;
            box-shadow: 0 0 12px rgba(76, 175, 80, 0.5);
        }

        .assignment-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
            margin-right: 4px;
        }

        .badge-locked {
            background: #1976d2;
            color: white;
        }

        .badge-incremental {
            background: #f57c00;
            color: white;
        }

        .badge-new {
            background: #2e7d32;
            color: white;
        }

        .assignment-cell-empty {
            color: #ccc;
            font-size: 0.9em;
            font-style: italic;
        }

        .assignment-emp-id {
            font-weight: 700;
            display: block;
            margin-bottom: 3px;
        }

        .assignment-shift {
            font-size: 0.8em;
            opacity: 0.9;
            display: block;
            margin-bottom: 2px;
        }

        .assignment-hours {
            font-size: 0.75em;
            opacity: 0.85;
            display: block;
        }

        .calendar-date-header {
            font-weight: 700;
            color: #667eea;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab-button {
                flex: 1 1 50%;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .filter-container {
                flex-direction: column;
            }

            .assignments-table {
                font-size: 0.9em;
            }

            .assignments-table th,
            .assignments-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä NGRS Solver Output Viewer</h1>
            <p>Interactive Dashboard for Workforce Scheduling Results</p>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 500;">Load Input File:</label>
                <input type="file" id="inputFileInput" accept=".json" style="display: none;">
                <button id="openInputFileBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9em;">üìÇ Open Input</button>
                <span id="loadedInputFileName" style="color: rgba(255,255,255,0.8); font-size: 0.9em;"></span>
                <span style="color: rgba(255,255,255,0.4); margin: 0 10px;">|</span>
                <label for="outputFileSelector" style="font-weight: 500;">Load Output File:</label>
                <select id="outputFileSelector" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 0.95em; cursor: pointer;">
                    <option value="">-- Select a file from output/ --</option>
                </select>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
                <button id="openFileBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9em;">üìÇ Open File</button>
                <span id="loadedFileName" style="color: rgba(255,255,255,0.8); font-size: 0.9em;"></span>
            </div>
        </div>

        <div class="tabs">
            <!-- FULL SOLVE SECTION -->
            <div class="section-label">üì¶ Full Solve</div>
            <button class="tab-button active" onclick="switchTab('input')">1Ô∏è‚É£ Input Data</button>
            <button class="tab-button" onclick="switchTab('summary')">2Ô∏è‚É£ Summary</button>
            <button class="tab-button" onclick="switchTab('assignments')">3Ô∏è‚É£ Assignments</button>
            <button class="tab-button" onclick="switchTab('employees')">4Ô∏è‚É£ Employee Details</button>
            <button class="tab-button" onclick="switchTab('violations')">5Ô∏è‚É£ Violations</button>
            <button class="tab-button" onclick="switchTab('emptyslots')">6Ô∏è‚É£ Demand Coverage</button>
            <button class="tab-button" onclick="switchTab('employeeroster')">7Ô∏è‚É£ Employee Roster</button>
            
            <!-- DIVIDER -->
            <div class="tab-divider"></div>
            
            <!-- INCREMENTAL SOLVE SECTION -->
            <div class="section-label">üîÑ Incremental Solve</div>
            <button class="tab-button" onclick="switchTab('incrementalinput')">8Ô∏è‚É£ Incremental Input</button>
            <button class="tab-button" onclick="switchTab('incrementaloutput')">9Ô∏è‚É£ Output Comparison</button>
        </div>

        <!-- INPUT DATA TAB -->
        <div id="input" class="tab-content active">
            <div class="section-header">
                <h2>üìã Input Configuration</h2>
                <p>View demand items, requirements, rotation patterns, employees, and configuration</p>
            </div>

            <div id="inputContainer"></div>
        </div>

        <!-- SUMMARY TAB -->
        <div id="summary" class="tab-content">
            <div id="incrementalInfo" style="display: none; background: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h3 style="color: #e65100; margin-bottom: 15px;">üîÑ Incremental Solve Mode</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Cutoff Date:</strong>
                        <div id="cutoffDate" style="font-size: 1.2em; color: #f57c00; font-weight: bold;">-</div>
                    </div>
                    <div>
                        <strong>Locked Assignments:</strong>
                        <div id="lockedCount" style="font-size: 1.2em; color: #1976d2; font-weight: bold;">-</div>
                    </div>
                    <div>
                        <strong>New Assignments:</strong>
                        <div id="newCount" style="font-size: 1.2em; color: #f57c00; font-weight: bold;">-</div>
                    </div>
                    <div>
                        <strong>Solvable Slots:</strong>
                        <div id="solvableSlots" style="font-size: 1.2em; color: #388e3c; font-weight: bold;">-</div>
                    </div>
                    <div>
                        <strong>Unassigned Slots:</strong>
                        <div id="unassignedSlots" style="font-size: 1.2em; color: #d32f2f; font-weight: bold;">-</div>
                    </div>
                </div>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Solver Status</h3>
                    <div class="value" id="status">-</div>
                </div>
                <div class="summary-card hard">
                    <h3>Hard Score</h3>
                    <div class="value" id="hardScore">0</div>
                </div>
                <div class="summary-card soft">
                    <h3>Soft Score</h3>
                    <div class="value" id="softScore">0</div>
                </div>
                <div class="summary-card overall">
                    <h3>Overall Score</h3>
                    <div class="value" id="overallScore">0</div>
                </div>
                <div class="summary-card status">
                    <h3>Total Assignments</h3>
                    <div class="value" id="totalAssignments">0</div>
                </div>
                <div class="summary-card status">
                    <h3>Duration (sec)</h3>
                    <div class="value" id="duration">0</div>
                </div>
            </div>

            <h2 style="margin: 30px 0 20px; color: #333;">Score Breakdown</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Hard Constraints</h3>
                    <div class="chart-container">
                        <canvas id="hardChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Soft Constraints</h3>
                    <div class="chart-container">
                        <canvas id="softChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ASSIGNMENTS TAB -->
        <div id="assignments" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">All Assignments</h2>
            <div class="filter-container">
                <input type="text" class="filter-input" id="employeeFilter" placeholder="üîç Filter by Employee ID">
                <input type="date" class="filter-input" id="dateFilter" placeholder="Filter by Date">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
            </div>

            <table class="assignments-table" id="assignmentsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Employee</th>
                        <th>Shift Code</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Gross (h)</th>
                        <th>Normal (h)</th>
                        <th>OT (h)</th>
                        <th>Lunch (h)</th>
                    </tr>
                </thead>
                <tbody id="assignmentsBody">
                </tbody>
            </table>
        </div>

        <!-- EMPLOYEES TAB -->
        <div id="employees" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Employee Details</h2>
            <div id="employeesContainer"></div>
        </div>

        <!-- VIOLATIONS TAB -->
        <div id="violations" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Constraint Violations</h2>
            <div id="violationsContainer"></div>
        </div>

        <!-- INCREMENTAL INPUT TAB -->
        <div id="incrementalinput" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">üîÑ Incremental Solve Input Comparison</h2>
            
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h3 style="color: #1565c0; margin-bottom: 10px;">üìÇ Load Incremental Input Files</h3>
                <p style="margin-bottom: 15px; color: #424242;">Load multiple incremental input files to compare temporal windows, employee changes, and constraints side-by-side.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1565c0;">Input File 1:</label>
                        <input type="file" id="incrementalInput1FileInput" accept=".json" style="display: none;">
                        <button id="openIncrementalInput1Btn" class="btn btn-primary" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÇ Open File 1</button>
                        <span id="loadedIncrementalInput1FileName" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1565c0;">Input File 2:</label>
                        <input type="file" id="incrementalInput2FileInput" accept=".json" style="display: none;">
                        <button id="openIncrementalInput2Btn" class="btn btn-primary" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÇ Open File 2</button>
                        <span id="loadedIncrementalInput2FileName" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1565c0;">Input File 3:</label>
                        <input type="file" id="incrementalInput3FileInput" accept=".json" style="display: none;">
                        <button id="openIncrementalInput3Btn" class="btn btn-primary" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÇ Open File 3</button>
                        <span id="loadedIncrementalInput3FileName" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>
            </div>
            
            <div id="incrementalInputContainer" style="color: #999; text-align: center; padding: 60px 20px; font-size: 1.1em;">
                ‚¨ÜÔ∏è Load incremental input files to view comparison
            </div>
        </div>

        <!-- EMPTY SLOTS TAB -->
        <div id="emptyslots" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Empty Slots by Demand</h2>
            <div id="emptySlotsContainer"></div>
        </div>

        <!-- EMPLOYEE ROSTER TAB -->
        <div id="employeeroster" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Employee Roster</h2>
            <div id="employeeRosterContainer"></div>
        </div>

        <!-- INCREMENTAL OUTPUT COMPARISON TAB -->
        <div id="incrementaloutput" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">üìä Incremental Output Comparison</h2>
            
            <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h3 style="color: #e65100; margin-bottom: 10px;">üìÇ Load Incremental Output Files</h3>
                <p style="margin-bottom: 15px; color: #424242;">Load multiple incremental output files to compare side-by-side. View locked vs incremental assignments, coverage gaps, and changes.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #e65100;">Output File 1:</label>
                        <input type="file" id="incrementalOutput1FileInput" accept=".json" style="display: none;">
                        <button id="openIncrementalOutput1Btn" class="btn btn-primary" style="padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÇ Open File 1</button>
                        <span id="loadedIncrementalOutput1FileName" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #e65100;">Output File 2:</label>
                        <input type="file" id="incrementalOutput2FileInput" accept=".json" style="display: none;">
                        <button id="openIncrementalOutput2Btn" class="btn btn-primary" style="padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÇ Open File 2</button>
                        <span id="loadedIncrementalOutput2FileName" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #e65100;">Output File 3:</label>
                        <input type="file" id="incrementalOutput3FileInput" accept=".json" style="display: none;">
                        <button id="openIncrementalOutput3Btn" class="btn btn-primary" style="padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÇ Open File 3</button>
                        <span id="loadedIncrementalOutput3FileName" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>
            </div>
            
            <div id="incrementalOutputContainer" style="color: #999; text-align: center; padding: 60px 20px; font-size: 1.1em;">
                ‚¨ÜÔ∏è Load incremental output files to view coverage comparison
            </div>
        </div>
    </div>

    <script>
        let outputData = null;
        let inputData = null;
        let filteredAssignments = [];
        let currentFile = null;
        let hardChartInstance = null;
        let softChartInstance = null;

        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Load available output files from server API
            loadAvailableFiles();
            
            // Setup file selector listener
            const outputFileSelector = document.getElementById('outputFileSelector');
            if (outputFileSelector) {
                outputFileSelector.addEventListener('change', (e) => {
                    const filePath = e.target.value;
                    if (filePath) {
                        loadOutputDataFromPath(filePath);
                    }
                });
            }
            
            // Setup file open button
            const openFileBtn = document.getElementById('openFileBtn');
            const fileInput = document.getElementById('fileInput');
            if (openFileBtn) {
                openFileBtn.addEventListener('click', () => {
                    fileInput.click();
                });
            }
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        loadOutputDataFromFile(file);
                    }
                });
            }
            
            // Setup input file open button
            const openInputFileBtn = document.getElementById('openInputFileBtn');
            const inputFileInput = document.getElementById('inputFileInput');
            if (openInputFileBtn) {
                openInputFileBtn.addEventListener('click', () => {
                    inputFileInput.click();
                });
            }
            if (inputFileInput) {
                inputFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        loadInputDataFromFile(file);
                    }
                });
            }
            
            // Legacy single incremental input button - now replaced with 3-file comparison
            // const openIncrementalInputBtn = document.getElementById('openIncrementalInputBtn');
            // const incrementalInputFileInput = document.getElementById('incrementalInputFileInput');
            
            // Setup incremental input file buttons (3 files)
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`openIncrementalInput${i}Btn`);
                const input = document.getElementById(`incrementalInput${i}FileInput`);
                if (btn && input) {
                    btn.addEventListener('click', () => input.click());
                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            loadIncrementalInputFromFile(file, i);
                        }
                    });
                }
            }
            
            // Setup incremental output file buttons (3 files)
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`openIncrementalOutput${i}Btn`);
                const input = document.getElementById(`incrementalOutput${i}FileInput`);
                if (btn && input) {
                    btn.addEventListener('click', () => input.click());
                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            loadIncrementalOutputFromFile(file, i);
                        }
                    });
                }
            }
        });

        async function loadAvailableFiles() {
            try {
                const response = await fetch('/api/output-files');
                if (!response.ok) {
                    console.log('Server API not available - using local file picker');
                    return;
                }
                
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    const selector = document.getElementById('outputFileSelector');
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.path;
                        option.textContent = file.name;
                        selector.appendChild(option);
                    });
                    console.log(`Loaded ${data.files.length} output files`);
                }
            } catch (error) {
                console.log('Could not load file list from server API:', error);
                console.log('Note: Run server.py for better file browsing experience');
            }
        }

        async function loadOutputDataFromPath(filePath) {
            try {
                console.log(`Loading file: ${filePath}`);
                currentFile = filePath;
                
                // Extract filename from path (e.g., "output/output_1211_1502.json" -> "output_1211_1502.json")
                const filename = filePath.split('/').pop();
                const apiUrl = `/api/output-file/${filename}`;
                
                console.log(`Fetching from API: ${apiUrl}`);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                outputData = await response.json();
                console.log('Loaded data:', outputData);
                console.log('Assignments count:', outputData.assignments?.length);
                
                document.getElementById('loadedFileName').textContent = `Loaded: ${filename}`;
                renderDashboard();
            } catch (error) {
                console.error(`Error loading ${filePath}:`, error);
                alert(`Error loading file. Make sure server.py is running.\n\nError: ${error.message}`);
            }
        }

        function loadOutputDataFromFile(file) {
            try {
                console.log(`Loading file from dialog: ${file.name}`);
                currentFile = file.name;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        outputData = JSON.parse(e.target.result);
                        console.log('Loaded data from file:', outputData);
                        console.log('Assignments count:', outputData.assignments?.length);
                        
                        document.getElementById('loadedFileName').textContent = `Loaded: ${file.name}`;
                        renderDashboard();
                    } catch (parseError) {
                        console.error('Error parsing JSON:', parseError);
                        alert(`Error parsing JSON file: ${parseError.message}`);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Error reading file:', error);
                    alert(`Error reading file: ${error}`);
                };
                reader.readAsText(file);
            } catch (error) {
                console.error(`Error loading file:`, error);
                alert(`Error loading file: ${error.message}`);
            }
        }

        function loadInputDataFromFile(file) {
            try {
                console.log(`Loading input file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        inputData = JSON.parse(e.target.result);
                        console.log('Loaded input data:', inputData);
                        
                        document.getElementById('loadedInputFileName').textContent = `Loaded: ${file.name}`;
                        renderInputData();
                    } catch (parseError) {
                        console.error('Error parsing input JSON:', parseError);
                        alert(`Error parsing JSON file: ${parseError.message}`);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Error reading input file:', error);
                    alert(`Error reading file: ${error}`);
                };
                reader.readAsText(file);
            } catch (error) {
                console.error(`Error loading input file:`, error);
                alert(`Error loading file: ${error.message}`);
            }
        }

        function renderInputData() {
            if (!inputData) {
                console.error('No input data available');
                return;
            }

            const container = document.getElementById('inputContainer');
            container.innerHTML = '';

            // Planning horizon and basic info
            const horizon = inputData.planningHorizon || {};
            const publicHolidays = inputData.publicHolidays || [];
            
            let html = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Planning Reference</h3>
                        <div class="value" style="font-size: 0.8em;">${inputData.planningReference || 'N/A'}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Planning Horizon</h3>
                        <div class="value" style="font-size: 0.9em;">${horizon.startDate || 'N/A'} to ${horizon.endDate || 'N/A'}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Public Holidays</h3>
                        <div class="value" style="font-size: 0.9em;">${publicHolidays.length > 0 ? publicHolidays.join(', ') : 'None'}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Employees</h3>
                        <div class="value">${(inputData.employees || []).length}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Demands</h3>
                        <div class="value">${(inputData.demandItems || []).length}</div>
                    </div>
                </div>
            `;

            // Demands and Requirements
            html += '<div class="section-header" style="margin-top: 30px;"><h3>üìã Demand Items & Requirements</h3></div>';
            
            const demands = inputData.demandItems || [];
            demands.forEach((demand, idx) => {
                const requirements = demand.requirements || [];
                const shifts = demand.shifts || [];
                
                html += `
                    <div class="employee-card" style="margin-bottom: 20px;">
                        <h3 style="color: #667eea;">${demand.demandId || `Demand ${idx + 1}`}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div><strong>Location:</strong> ${demand.locationId || 'N/A'}</div>
                            <div><strong>OU:</strong> ${demand.ouId || 'N/A'}</div>
                            <div><strong>Shift Start:</strong> ${demand.shiftStartDate || 'N/A'}</div>
                        </div>
                `;
                
                // Shift details
                if (shifts.length > 0) {
                    html += '<div style="margin-bottom: 15px;"><strong>Shift Definitions:</strong></div>';
                    shifts.forEach((shift, sidx) => {
                        const shiftDetails = shift.shiftDetails || [];
                        const coverageDays = shift.coverageDays || [];
                        const coverageDaysStr = Array.isArray(coverageDays) ? coverageDays.join(', ') : coverageDays;
                        const coverageDaysCount = Array.isArray(coverageDays) ? coverageDays.length : 0;
                        html += `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 0.9em;">
                                    <div><strong>Coverage Days:</strong> <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; font-weight: 600;">${coverageDaysStr} (${coverageDaysCount} Days)</span></div>
                                    <div><strong>Include PH:</strong> ${shift.includePublicHolidays !== undefined ? shift.includePublicHolidays : 'N/A'}</div>
                                    <div><strong>Include Eve PH:</strong> ${shift.includeEveOfPublicHolidays !== undefined ? shift.includeEveOfPublicHolidays : 'N/A'}</div>
                                </div>
                                <div style="margin-top: 8px;">
                                    ${shiftDetails.map(sd => `
                                        <span style="display: inline-block; background: #667eea; color: white; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 0.85em;">
                                            ${sd.shiftCode}: ${sd.start}-${sd.end}${sd.nextDay ? ' +1' : ''}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Requirements table
                if (requirements.length > 0) {
                    html += `
                        <div style="margin-top: 15px;">
                            <strong>Requirements (${requirements.length}):</strong>
                            <div style="overflow-x: auto; margin-top: 10px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead>
                                        <tr style="background: #f0f0f0;">
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Req ID</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Product Type</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Rank</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Headcount</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Gender</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Scheme</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Rotation</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Qualifications</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    requirements.forEach(req => {
                        const rotation = (req.workPattern || req.rotationSequence || []).join(' - ');
                        const quals = req.requiredQualifications || [];
                        html += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.requirementId || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.productTypeId || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.rankId || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${req.headcount || 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.gender || 'Any'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${req.Scheme || 'Global'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${rotation}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.85em;">${quals.join(', ') || 'None'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
            });

            // Employees
            html += '<div class="section-header" style="margin-top: 30px;"><h3>üë• Employees</h3></div>';
            
            const employees = inputData.employees || [];
            if (employees.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
                
                employees.forEach(emp => {
                    const qualifications = emp.qualifications || [];
                    html += `
                        <div class="employee-card">
                            <h3 style="color: #667eea;">${emp.employeeId || 'N/A'}</h3>
                            <div style="margin-bottom: 10px;">
                                <div><strong>Rank:</strong> ${emp.rankId || 'N/A'}</div>
                                <div><strong>Product Type:</strong> ${emp.productTypeId || 'N/A'}</div>
                                <div><strong>Team:</strong> ${emp.teamId || 'N/A'}</div>
                                <div><strong>OU:</strong> ${emp.ouId || 'N/A'}</div>
                                <div><strong>Scheme:</strong> ${emp.scheme || 'N/A'}</div>
                                <div><strong>Gender:</strong> ${emp.gender || 'N/A'}</div>
                                <div><strong>Rotation Offset:</strong> ${emp.rotationOffset !== undefined ? emp.rotationOffset : 'N/A'}</div>
                            </div>
                            ${qualifications.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <strong>Qualifications:</strong>
                                    <div style="margin-top: 5px;">
                                        ${qualifications.map(q => `
                                            <div style="background: #f0f0f0; padding: 5px; border-radius: 3px; margin: 3px 0; font-size: 0.85em;">
                                                <strong>${q.code}</strong><br>
                                                Valid: ${q.validFrom} ‚Üí ${q.expiryDate}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="no-data">No employees defined</div>';
            }

            // Constraints
            html += '<div class="section-header" style="margin-top: 30px;"><h3>‚öôÔ∏è Constraints</h3></div>';
            
            const constraints = inputData.constraintList || [];
            if (constraints.length > 0) {
                const hardConstraints = constraints.filter(c => c.enforcement === 'hard');
                const softConstraints = constraints.filter(c => c.enforcement === 'soft');
                
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
                
                html += `
                    <div>
                        <h4 style="color: #f5576c; margin-bottom: 10px;">Hard Constraints (${hardConstraints.length})</h4>
                        <div style="background: #fff5f5; padding: 15px; border-radius: 8px;">
                            ${hardConstraints.map(c => `
                                <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong style="color: #f5576c;">${c.id}</strong><br>
                                    <span style="font-size: 0.85em; color: #666;">${c.description || 'No description'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color: #4ecdc4; margin-bottom: 10px;">Soft Constraints (${softConstraints.length})</h4>
                        <div style="background: #f0fcfc; padding: 15px; border-radius: 8px;">
                            ${softConstraints.map(c => `
                                <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong style="color: #4ecdc4;">${c.id}</strong><br>
                                    <span style="font-size: 0.85em; color: #666;">${c.description || 'No description'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                html += '</div>';
            } else {
                html += '<div class="no-data">No constraints defined</div>';
            }

            container.innerHTML = html;
        }

        // ============================================================================
        // INCREMENTAL INPUT LOADER & RENDERER
        // ============================================================================
        
        let incrementalInputData = null;
        
        function loadIncrementalInputFromFile(file) {
            try {
                console.log(`Loading incremental input file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        incrementalInputData = JSON.parse(e.target.result);
                        console.log('Loaded incremental input data:', incrementalInputData);
                        
                        document.getElementById('loadedIncrementalInputFileName').textContent = `Loaded: ${file.name}`;
                        renderIncrementalInput();
                    } catch (parseError) {
                        console.error('Error parsing incremental input JSON:', parseError);
                        alert(`Error parsing JSON file: ${parseError.message}`);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Error reading incremental input file:', error);
                    alert(`Error reading file: ${error}`);
                };
                reader.readAsText(file);
            } catch (error) {
                console.error(`Error loading incremental input file:`, error);
                alert(`Error loading file: ${error.message}`);
            }
        }
        
        function renderIncrementalInput() {
            if (!incrementalInputData) {
                console.error('No incremental input data available');
                return;
            }

            const container = document.getElementById('incrementalInputContainer');
            
            // Temporal window
            const temporalWindow = incrementalInputData.temporalWindow || {};
            let html = `
                <div class="section-header">
                    <h3>‚è∞ Temporal Window</h3>
                    <p>Define the solve period and cutoff date</p>
                </div>
                <div class="summary-grid">
                    <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h3>Cutoff Date</h3>
                        <div class="value" style="font-size: 1.8em;">${temporalWindow.cutoffDate || 'N/A'}</div>
                        <p style="font-size: 0.85em; margin-top: 5px; opacity: 0.9;">Assignments locked before this date</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3>Solve From</h3>
                        <div class="value" style="font-size: 1.8em;">${temporalWindow.solveFromDate || 'N/A'}</div>
                        <p style="font-size: 0.85em; margin-top: 5px; opacity: 0.9;">Start of solve window</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3>Solve To</h3>
                        <div class="value" style="font-size: 1.8em;">${temporalWindow.solveToDate || 'N/A'}</div>
                        <p style="font-size: 0.85em; margin-top: 5px; opacity: 0.9;">End of solve window</p>
                    </div>
                </div>
            `;
            
            // Employee changes
            const empChanges = incrementalInputData.employeeChanges || {};
            const newJoiners = empChanges.newJoiners || [];
            const notAvailable = empChanges.notAvailableFrom || [];
            const longLeave = empChanges.longLeave || [];
            
            html += `
                <div class="section-header" style="margin-top: 30px;">
                    <h3>üë• Employee Changes</h3>
                    <p>New joiners, departures, and leave periods</p>
                </div>
            `;
            
            if (newJoiners.length > 0 || notAvailable.length > 0 || longLeave.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
                
                // New Joiners
                if (newJoiners.length > 0) {
                    html += `
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; border: 2px solid #4caf50;">
                            <h4 style="color: #2e7d32; margin-bottom: 15px;">‚ú® New Joiners (${newJoiners.length})</h4>
                            ${newJoiners.map(item => {
                                const emp = item.employee || item;
                                return `
                                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">${emp.employeeId || 'N/A'}</div>
                                    <div style="font-size: 0.9em; color: #666;">
                                        <div>Available from: <strong>${item.availableFrom || 'N/A'}</strong></div>
                                        <div>Rank: ${emp.rankId || 'N/A'}</div>
                                        <div>Product Type: ${emp.productTypeId || 'N/A'}</div>
                                        <div>Team: ${emp.ouId || 'N/A'}</div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `;
                }
                
                // Departed employees
                if (notAvailable.length > 0) {
                    html += `
                        <div style="background: #ffebee; padding: 20px; border-radius: 12px; border: 2px solid #f44336;">
                            <h4 style="color: #c62828; margin-bottom: 15px;">üö™ Departures (${notAvailable.length})</h4>
                            ${notAvailable.map(emp => `
                                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #f44336;">
                                    <div style="font-weight: 600; color: #c62828; margin-bottom: 5px;">${emp.employeeId || 'N/A'}</div>
                                    <div style="font-size: 0.9em; color: #666;">
                                        Not available from: <strong>${emp.notAvailableFrom || 'N/A'}</strong>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Long leave
                if (longLeave.length > 0) {
                    html += `
                        <div style="background: #fff3e0; padding: 20px; border-radius: 12px; border: 2px solid #ff9800;">
                            <h4 style="color: #e65100; margin-bottom: 15px;">üèñÔ∏è Long Leave (${longLeave.length})</h4>
                            ${longLeave.map(emp => `
                                <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <div style="font-weight: 600; color: #e65100; margin-bottom: 5px;">${emp.employeeId || 'N/A'}</div>
                                    <div style="font-size: 0.9em; color: #666;">
                                        <div>Leave: <strong>${emp.leaveStartDate || 'N/A'}</strong> ‚Üí <strong>${emp.leaveEndDate || 'N/A'}</strong></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html += '</div>';
            } else {
                html += '<div class="no-data">No employee changes specified</div>';
            }
            
            // Previous output summary
            const prevOutput = incrementalInputData.previousOutput;
            html += `
                <div class="section-header" style="margin-top: 30px;">
                    <h3>üìÑ Previous Output Reference</h3>
                    <p>Baseline assignments to build upon</p>
                </div>
            `;
            
            if (prevOutput) {
                const prevAssignments = prevOutput.assignments || [];
                // Extract unique employees from assignments (schema 0.4 doesn't have employees array)
                const uniqueEmployees = new Set(prevAssignments.map(a => a.employeeId).filter(id => id));
                html += `
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>Previous Assignments</h3>
                            <div class="value">${prevAssignments.length}</div>
                        </div>
                        <div class="summary-card">
                            <h3>Previous Employees</h3>
                            <div class="value">${uniqueEmployees.size}</div>
                        </div>
                    </div>
                `;
            } else {
                html += '<div class="no-data">No previous output embedded</div>';
            }
            
            container.innerHTML = html;
        }
        
        // ============================================================================
        // INCREMENTAL INPUT COMPARISON LOADER & RENDERER
        // ============================================================================
        
        let incrementalInputFiles = [null, null, null];
        
        function loadIncrementalInputFromFile(file, index) {
            try {
                console.log(`Loading incremental input file ${index}: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        incrementalInputFiles[index - 1] = data;
                        console.log(`Loaded incremental input ${index}:`, data);
                        
                        document.getElementById(`loadedIncrementalInput${index}FileName`).textContent = file.name;
                        
                        renderIncrementalInputComparison();
                    } catch (err) {
                        console.error(`Error parsing incremental input file ${index}:`, err);
                        alert(`Error parsing JSON file ${index}: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            } catch (err) {
                console.error(`Error loading incremental input file ${index}:`, err);
                alert(`Error loading file ${index}: ${err.message}`);
            }
        }
        
        function renderIncrementalInputComparison() {
            const container = document.getElementById('incrementalInputContainer');
            
            const loadedCount = incrementalInputFiles.filter(f => f !== null).length;
            
            if (loadedCount === 0) {
                container.innerHTML = '<div style=\"color: #999; text-align: center; padding: 60px 20px; font-size: 1.1em;\">‚¨ÜÔ∏è Load incremental input files to view comparison</div>';
                return;
            }
            
            let html = `
                <div class=\"section-header\">
                    <h3>üìä Input Comparison (${loadedCount} file${loadedCount > 1 ? 's' : ''} loaded)</h3>
                    <p>Compare temporal windows, employee changes, and constraints across scenarios</p>
                </div>
            `;
            
            // Side-by-side comparison
            html += '<div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;\">';
            
            incrementalInputFiles.forEach((data, idx) => {
                if (!data) return;
                
                const fileNum = idx + 1;
                const temporalWindow = data.temporalWindow || {};
                const employeeChanges = data.employeeChanges || {};
                const newJoiners = employeeChanges.newJoiners || [];
                const notAvailable = employeeChanges.notAvailableFrom || [];
                const longLeave = employeeChanges.longLeave || [];
                const prevOutput = data.previousOutput || {};
                const prevAssignments = prevOutput.assignments || [];
                
                html += `
                    <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;\">
                        <h4 style=\"margin-bottom: 15px; font-size: 1.3em;\">üìÑ Input ${fileNum}</h4>
                        
                        <div style=\"background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;\">
                            <h5 style=\"margin-bottom: 10px; font-size: 1.1em;\">‚è±Ô∏è Temporal Window</h5>
                            <div style=\"margin-bottom: 8px;\"><strong>Cutoff Date:</strong> ${temporalWindow.cutoffDate || 'N/A'}</div>
                            <div style=\"margin-bottom: 8px;\"><strong>Solve Window:</strong> ${temporalWindow.solveFromDate || 'N/A'} ‚Üí ${temporalWindow.solveToDate || 'N/A'}</div>
                        </div>
                        
                        <div style=\"background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;\">
                            <h5 style=\"margin-bottom: 10px; font-size: 1.1em;\">üë• Employee Changes</h5>
                            <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;\">
                                <div style=\"background: rgba(76, 175, 80, 0.3); padding: 8px; border-radius: 6px;\">
                                    <div style=\"font-size: 1.5em; font-weight: bold;\">${newJoiners.length}</div>
                                    <div style=\"font-size: 0.8em;\">‚ú® New</div>
                                </div>
                                <div style=\"background: rgba(244, 67, 54, 0.3); padding: 8px; border-radius: 6px;\">
                                    <div style=\"font-size: 1.5em; font-weight: bold;\">${notAvailable.length}</div>
                                    <div style=\"font-size: 0.8em;\">üö™ Departed</div>
                                </div>
                                <div style=\"background: rgba(255, 152, 0, 0.3); padding: 8px; border-radius: 6px;\">
                                    <div style=\"font-size: 1.5em; font-weight: bold;\">${longLeave.length}</div>
                                    <div style=\"font-size: 0.8em;\">üèñÔ∏è Leave</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style=\"background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;\">
                            <h5 style=\"margin-bottom: 10px; font-size: 1.1em;\">üìã Previous Output</h5>
                            <div style=\"margin-bottom: 8px;\"><strong>Assignments:</strong> ${prevAssignments.length}</div>
                            <div style=\"margin-bottom: 8px;\"><strong>Employees:</strong> ${new Set(prevAssignments.map(a => a.employeeId).filter(id => id)).size}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // ============================================================================
        // INCREMENTAL OUTPUT COMPARISON LOADER & RENDERER
        // ============================================================================
        
        let incrementalOutputFiles = [null, null, null];
        
        function loadIncrementalOutputFromFile(file, index) {
            try {
                console.log(`Loading incremental output file ${index}: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        incrementalOutputFiles[index - 1] = data;
                        console.log(`Loaded incremental output ${index}:`, data);
                        
                        document.getElementById(`loadedIncrementalOutput${index}FileName`).textContent = file.name;
                        renderIncrementalOutputComparison();
                    } catch (parseError) {
                        console.error(`Error parsing incremental output JSON ${index}:`, parseError);
                        alert(`Error parsing JSON file: ${parseError.message}`);
                    }
                };
                reader.onerror = (error) => {
                    console.error(`Error reading incremental output file ${index}:`, error);
                    alert(`Error reading file: ${error}`);
                };
                reader.readAsText(file);
            } catch (error) {
                console.error(`Error loading incremental output file ${index}:`, error);
                alert(`Error loading file: ${error.message}`);
            }
        }
        
        function renderIncrementalOutputComparison() {
            const loadedCount = incrementalOutputFiles.filter(f => f !== null).length;
            if (loadedCount === 0) {
                document.getElementById('incrementalOutputContainer').innerHTML = 
                    '<div style="color: #999; text-align: center; padding: 60px 20px; font-size: 1.1em;">‚¨ÜÔ∏è Load incremental output files to view coverage comparison</div>';
                return;
            }
            
            const container = document.getElementById('incrementalOutputContainer');
            let html = `
                <div class="section-header">
                    <h3>üìä Coverage Comparison (${loadedCount} file${loadedCount > 1 ? 's' : ''} loaded)</h3>
                    <p>Compare locked vs incremental assignments, coverage gaps, and changes</p>
                </div>
            `;
            
            // Side-by-side comparison
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">';
            
            incrementalOutputFiles.forEach((data, idx) => {
                if (!data) return;
                
                const fileNum = idx + 1;
                const incrementalSolve = data.incrementalSolve || {};
                const assignments = data.assignments || [];
                
                // Handle "no_slots_to_solve" scenario
                const isNoSlotsScenario = incrementalSolve.status === 'no_slots_to_solve';
                const lockedCount = isNoSlotsScenario ? assignments.length : (incrementalSolve.lockedAssignmentsCount || 0);
                const newCount = isNoSlotsScenario ? 0 : (incrementalSolve.newAssignmentsCount || 0);
                const solvableSlots = isNoSlotsScenario ? 0 : (incrementalSolve.solvableSlots || 0);
                const unassignedSlots = isNoSlotsScenario ? 0 : (incrementalSolve.unassignedSlots || 0);
                const coveragePercent = solvableSlots > 0 ? ((solvableSlots - unassignedSlots) / solvableSlots * 100).toFixed(1) : (isNoSlotsScenario ? 0 : 0);
                
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                        <h4 style="margin-bottom: 15px; font-size: 1.3em;">üìÑ Output ${fileNum}</h4>
                        
                        ${isNoSlotsScenario ? `
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                                <div style="font-size: 1.5em; margin-bottom: 10px;">‚úÖ</div>
                                <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">No Changes Required</div>
                                <div style="font-size: 0.95em; opacity: 0.9;">${incrementalSolve.message || 'All slots are locked. No incremental solving required.'}</div>
                            </div>
                        ` : `
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="margin-bottom: 8px;"><strong>Cutoff Date:</strong> ${incrementalSolve.cutoffDate || 'N/A'}</div>
                                <div style="margin-bottom: 8px;"><strong>Solve Window:</strong> ${incrementalSolve.solveFromDate || 'N/A'} ‚Üí ${incrementalSolve.solveToDate || 'N/A'}</div>
                            </div>
                        `}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${lockedCount}</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">üîí Locked</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${newCount}</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">üîÑ New</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="margin-bottom: 10px;"><strong>Solvable Slots:</strong> ${solvableSlots}</div>
                            <div style="margin-bottom: 10px;"><strong>Unassigned:</strong> <span style="color: ${unassignedSlots > 0 ? '#ff5252' : '#69f0ae'};">${unassignedSlots}</span></div>
                            <div style="margin-bottom: 10px;"><strong>Coverage:</strong> <span style="font-size: 1.5em; font-weight: bold;">${coveragePercent}%</span></div>
                            <div style="background: rgba(0,0,0,0.2); border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #69f0ae 0%, #00e676 100%); height: 100%; width: ${coveragePercent}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <strong>Solver Status:</strong> <span style="font-size: 1.2em; font-weight: bold;">${isNoSlotsScenario ? 'FEASIBLE' : (data.solverRun?.status || 'N/A')}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Coverage gaps analysis (if any file has gaps)
            const hasGaps = incrementalOutputFiles.some(data => 
                data && (data.incrementalSolve?.unassignedSlots || 0) > 0
            );
            
            if (hasGaps) {
                html += `
                    <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 20px; margin-top: 20px; border-radius: 8px;">
                        <h4 style="color: #c62828; margin-bottom: 10px;">‚ö†Ô∏è Coverage Gaps Detected</h4>
                        <p style="color: #666;">Some files have unassigned slots in the solve window. Review demand requirements and employee availability.</p>
                    </div>
                `;
            }
            
            // Add demand coverage calendar
            html += renderDemandCoverageCalendar(incrementalOutputFiles);
            
            container.innerHTML = html;
        }
        
        // ============================================================================
        // DEMAND COVERAGE CALENDAR
        // ============================================================================
        
        function renderDemandCoverageCalendar(outputFiles) {
            const loadedFiles = outputFiles.filter(f => f !== null);
            if (loadedFiles.length === 0) return '';
            
            // Get all unique demands and dates across all files
            const demandsMap = new Map();
            const allDates = new Set();
            
            loadedFiles.forEach((file, fileIdx) => {
                const assignments = file.assignments || [];
                const demands = file.inputData?.demands || [];
                
                assignments.forEach(assignment => {
                    const demandId = assignment.demandId;
                    const date = assignment.date;
                    
                    if (!demandsMap.has(demandId)) {
                        const demand = demands.find(d => d.demandId === demandId) || { demandId };
                        demandsMap.set(demandId, {
                            demandId,
                            description: demand.description || demandId,
                            coverage: {}
                        });
                    }
                    
                    if (!demandsMap.get(demandId).coverage[date]) {
                        demandsMap.get(demandId).coverage[date] = [];
                    }
                    
                    demandsMap.get(demandId).coverage[date][fileIdx] = assignment.employeeId ? true : false;
                    allDates.add(date);
                });
            });
            
            const sortedDates = Array.from(allDates).sort();
            const demands = Array.from(demandsMap.values());
            
            if (demands.length === 0 || sortedDates.length === 0) return '';
            
            let html = `
                <div style="margin-top: 30px;">
                    <div class="section-header">
                        <h3>üìÖ Demand Coverage Calendar</h3>
                        <p>Visual comparison of demand coverage across loaded files. Empty cells indicate unassigned slots.</p>
                    </div>
                    
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.2); position: sticky; left: 0; background: inherit; z-index: 2;">Demand</th>
                                    ${sortedDates.map(date => `<th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2); min-width: 100px;">${date}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            demands.forEach((demand, demandIdx) => {
                html += `<tr style="background: ${demandIdx % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600; position: sticky; left: 0; background: inherit; z-index: 1;">${demand.description.substring(0, 30)}${demand.description.length > 30 ? '...' : ''}</td>`;
                
                sortedDates.forEach(date => {
                    const coverage = demand.coverage[date] || [];
                    const fileCount = loadedFiles.length;
                    
                    let cellStyle = 'padding: 8px; border: 1px solid #dee2e6; text-align: center;';
                    let cellContent = '';
                    
                    if (fileCount === 1) {
                        // Single file: show filled or empty
                        if (coverage[0]) {
                            cellStyle += ' background: #c8e6c9;'; // Green - covered
                            cellContent = '‚úì';
                        } else {
                            cellStyle += ' background: #ffcdd2;'; // Red - empty
                            cellContent = '‚úó';
                        }
                    } else if (fileCount === 2) {
                        // Two files: show comparison
                        const file1Covered = coverage[0] || false;
                        const file2Covered = coverage[1] || false;
                        
                        if (file1Covered && file2Covered) {
                            cellStyle += ' background: #c8e6c9;'; // Both covered
                            cellContent = '‚úì‚úì';
                        } else if (!file1Covered && !file2Covered) {
                            cellStyle += ' background: #ffcdd2;'; // Both empty
                            cellContent = '‚úó‚úó';
                        } else if (file1Covered && !file2Covered) {
                            cellStyle += ' background: #fff9c4; font-weight: bold;'; // Changed: was covered, now empty
                            cellContent = '‚úì‚Üí‚úó';
                        } else {
                            cellStyle += ' background: #b3e5fc; font-weight: bold;'; // Changed: was empty, now covered
                            cellContent = '‚úó‚Üí‚úì';
                        }
                    } else if (fileCount === 3) {
                        // Three files: show progression
                        const file1Covered = coverage[0] || false;
                        const file2Covered = coverage[1] || false;
                        const file3Covered = coverage[2] || false;
                        
                        if (file1Covered && file2Covered && file3Covered) {
                            cellStyle += ' background: #c8e6c9;'; // All covered
                            cellContent = '‚úì';
                        } else if (!file1Covered && !file2Covered && !file3Covered) {
                            cellStyle += ' background: #ffcdd2;'; // All empty
                            cellContent = '‚úó';
                        } else {
                            // Show progression
                            const progression = [
                                file1Covered ? '‚úì' : '‚úó',
                                file2Covered ? '‚úì' : '‚úó',
                                file3Covered ? '‚úì' : '‚úó'
                            ].join('‚Üí');
                            
                            // Highlight if there are changes
                            const hasChanges = !(file1Covered === file2Covered && file2Covered === file3Covered);
                            if (hasChanges) {
                                cellStyle += ' background: #fff9c4; font-weight: bold; font-size: 0.75em;';
                            } else {
                                cellStyle += ' background: #e0e0e0; font-size: 0.75em;';
                            }
                            
                            // Add red border if final file (file3) is empty
                            if (!file3Covered) {
                                cellStyle += ' border: 3px solid #f44336 !important;';
                            }
                            
                            cellContent = progression;
                        }
                    }
                    
                    html += `<td style="${cellStyle}">${cellContent}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #c8e6c9; border-radius: 4px; display: flex; align-items: center; justify-content: center;">‚úì</div>
                            <span>Covered</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #ffcdd2; border-radius: 4px; display: flex; align-items: center; justify-content: center;">‚úó</div>
                            <span>Empty Slot</span>
                        </div>
                        ${loadedFiles.length > 1 ? `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #fff9c4; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7em;">‚úì‚Üí‚úó</div>
                            <span>Coverage Lost</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #b3e5fc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7em;">‚úó‚Üí‚úì</div>
                            <span>Coverage Gained</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderDashboard() {
            if (!outputData) {
                console.error('No output data available');
                return;
            }

            console.log('Rendering dashboard...');
            try {
                renderSummary();
                console.log('Summary rendered');
                renderAssignments();
                console.log('Assignments rendered');
                renderEmployees();
                console.log('Employees rendered');
                renderViolations();
                console.log('Violations rendered');
                renderEmptySlots();
                console.log('Empty Slots rendered');
                renderEmployeeRoster();
                console.log('Employee Roster rendered');
            } catch (error) {
                console.error('Error rendering dashboard:', error);
                alert(`Error rendering dashboard: ${error.message}`);
            }
        }

        function renderSummary() {
            const score = outputData.score || {};
            const solverRun = outputData.solverRun || {};
            const incrementalSolve = outputData.incrementalSolve || {};

            document.getElementById('status').textContent = solverRun.status || 'UNKNOWN';
            document.getElementById('hardScore').textContent = score.hard || 0;
            document.getElementById('softScore').textContent = score.soft || 0;
            document.getElementById('overallScore').textContent = score.overall || 0;
            document.getElementById('totalAssignments').textContent = outputData.assignments?.length || 0;
            document.getElementById('duration').textContent = (solverRun.durationSeconds || 0).toFixed(2);

            // Show incremental solve info if available
            const incrementalInfo = document.getElementById('incrementalInfo');
            if (incrementalSolve && incrementalSolve.cutoffDate) {
                incrementalInfo.style.display = 'block';
                document.getElementById('cutoffDate').textContent = incrementalSolve.cutoffDate || '-';
                document.getElementById('lockedCount').textContent = incrementalSolve.lockedAssignmentsCount || 0;
                document.getElementById('newCount').textContent = incrementalSolve.newAssignmentsCount || 0;
                document.getElementById('solvableSlots').textContent = incrementalSolve.solvableSlots || 0;
                document.getElementById('unassignedSlots').textContent = incrementalSolve.unassignedSlots || 0;
            } else {
                incrementalInfo.style.display = 'none';
            }

            // Destroy existing chart instances
            if (hardChartInstance) {
                hardChartInstance.destroy();
            }
            if (softChartInstance) {
                softChartInstance.destroy();
            }

            // Create score charts
            const hardViolations = outputData.scoreBreakdown?.hard?.violations || [];
            const hardChartCtx = document.getElementById('hardChart').getContext('2d');
            hardChartInstance = new Chart(hardChartCtx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Violations: ${hardViolations.length}`,
                        `Satisfied`
                    ],
                    datasets: [{
                        data: [
                            hardViolations.length,
                            Math.max(0, 10 - hardViolations.length)
                        ],
                        backgroundColor: ['#f5576c', '#43e97b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Soft score chart
            const softChart = document.getElementById('softChart');
            if (softChart) {
                const softChartCtx = softChart.getContext('2d');
                softChartInstance = new Chart(softChartCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Soft Score'],
                        datasets: [{
                            label: 'Penalty',
                            data: [Math.abs(score.soft || 0)],
                            backgroundColor: '#4facfe',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        function renderAssignments() {
            const assignments = outputData.assignments || [];
            filteredAssignments = assignments;

            // Detect new employees from employeeChanges if available
            const newEmployeeIds = new Set();
            if (outputData.employeeChanges && outputData.employeeChanges.newJoiners) {
                outputData.employeeChanges.newJoiners.forEach(nj => {
                    newEmployeeIds.add(nj.employee.employeeId);
                });
            }

            const tbody = document.getElementById('assignmentsBody');
            tbody.innerHTML = '';

            if (assignments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No assignments available</td></tr>';
                return;
            }

            assignments.forEach(a => {
                const hours = a.hours || {};
                const auditInfo = a.auditInfo || {};
                const source = auditInfo.source || '';
                const isNewEmployee = newEmployeeIds.has(a.employeeId);
                
                // Create badges
                let badges = '';
                if (source === 'locked') {
                    badges += '<span class="assignment-badge badge-locked">üîí LOCKED</span>';
                } else if (source === 'incremental') {
                    badges += '<span class="assignment-badge badge-incremental">üîÑ INCREMENTAL</span>';
                }
                if (isNewEmployee) {
                    badges += '<span class="assignment-badge badge-new">‚ú® NEW</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${a.date || '-'}</td>
                    <td><strong>${a.employeeId || '-'}</strong>${badges ? '<br>' + badges : ''}</td>
                    <td>${a.shiftCode || '-'}</td>
                    <td>${a.startDateTime ? new Date(a.startDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                    <td>${a.endDateTime ? new Date(a.endDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                    <td>${hours.gross !== undefined ? hours.gross.toFixed(1) : '-'}</td>
                    <td>${hours.normal !== undefined ? hours.normal.toFixed(1) : '-'}</td>
                    <td><strong style="color: #f5576c;">${hours.ot !== undefined ? hours.ot.toFixed(1) : '0.0'}</strong></td>
                    <td>${hours.lunch !== undefined ? hours.lunch.toFixed(1) : '0.0'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderEmployees() {
            const employeeHours = outputData.meta?.employeeHours || {};
            const container = document.getElementById('employeesContainer');
            container.innerHTML = '';

            if (Object.keys(employeeHours).length === 0) {
                container.innerHTML = '<div class="no-data">No employee data available</div>';
                return;
            }

            // Get newRotationOffset and workPattern for each employee
            const assignments = outputData.assignments || [];
            const employeeInfo = {};
            
            // Extract newRotationOffset from assignments
            assignments.forEach(a => {
                if (a.employeeId && !employeeInfo[a.employeeId]) {
                    employeeInfo[a.employeeId] = {
                        newRotationOffset: a.newRotationOffset !== undefined ? a.newRotationOffset : 'N/A',
                        requirementId: a.requirementId
                    };
                }
            });

            // Get BASE work pattern from demand requirement (not employee-specific)
            const getBaseWorkPattern = (requirementId) => {
                // Try to get from ICPMP preprocessing first
                if (outputData.icpmp_preprocessing?.requirements) {
                    const reqData = outputData.icpmp_preprocessing.requirements[requirementId];
                    if (reqData?.work_pattern) {
                        return reqData.work_pattern;
                    }
                }
                
                // Try from output data's unmetDemand structure
                if (outputData.unmetDemand && Array.isArray(outputData.unmetDemand)) {
                    for (const demand of outputData.unmetDemand) {
                        if (demand.requirementId === requirementId && demand.workPattern) {
                            return demand.workPattern;
                        }
                    }
                }
                
                // Fallback to input data if available
                if (inputData?.demandItems) {
                    for (const demandItem of inputData.demandItems) {
                        for (const req of demandItem.requirements || []) {
                            if (req.requirementId === requirementId && req.workPattern) {
                                return req.workPattern;
                            }
                        }
                    }
                }
                
                // Last resort: reconstruct from ALL assignments for this requirement
                const reqAssignments = assignments.filter(a => 
                    a.requirementId === requirementId &&
                    a.patternDay !== undefined
                );
                
                if (reqAssignments.length > 0) {
                    // Find max pattern day to determine pattern length
                    const maxPatternDay = Math.max(...reqAssignments.map(a => a.patternDay));
                    const pattern = new Array(maxPatternDay + 1).fill(null);
                    
                    // Fill in shift codes for each pattern day
                    reqAssignments.forEach(a => {
                        if (a.patternDay < pattern.length && !pattern[a.patternDay]) {
                            pattern[a.patternDay] = a.shiftCode;
                        }
                    });
                    
                    // Detect cycle length by checking date gaps
                    const sortedAssigns = reqAssignments.sort((a, b) => a.date.localeCompare(b.date));
                    let cycleLength = maxPatternDay + 1;
                    
                    for (let i = 1; i < Math.min(sortedAssigns.length, 10); i++) {
                        if (sortedAssigns[i].patternDay === 0 && sortedAssigns[i-1].patternDay === maxPatternDay) {
                            const date1 = new Date(sortedAssigns[i-1].date);
                            const date2 = new Date(sortedAssigns[i].date);
                            cycleLength = Math.round((date2 - date1) / (1000 * 60 * 60 * 24));
                            break;
                        }
                    }
                    
                    // Fill remaining days with 'O'
                    for (let i = pattern.length; i < cycleLength; i++) {
                        pattern[i] = 'O';
                    }
                    
                    return pattern.filter(p => p !== null);
                }
                
                return [];
            };
            
            // Get employee-specific work pattern (rotated according to their offset)
            const getWorkPattern = (empId, requirementId, rotationOffset) => {
                const basePattern = getBaseWorkPattern(requirementId);
                
                if (basePattern.length === 0 || rotationOffset === undefined || rotationOffset === null) {
                    return basePattern;
                }
                
                // Rotate the pattern according to employee's rotation offset
                // Rotation offset shifts where the employee starts in the pattern
                const offset = rotationOffset % basePattern.length;
                const rotatedPattern = [
                    ...basePattern.slice(offset),
                    ...basePattern.slice(0, offset)
                ];
                
                return rotatedPattern;
            };

            Object.entries(employeeHours).sort((a, b) => a[0].localeCompare(b[0])).forEach(([empId, data], index) => {
                const card = document.createElement('div');
                card.className = 'employee-card';

                const weeklyHours = Object.values(data.weekly_normal || {}).reduce((a, b) => a + b, 0);
                const monthlyOt = Object.values(data.monthly_ot || {}).reduce((a, b) => a + b, 0);
                
                const empData = employeeInfo[empId] || {};
                const rotationOffset = empData.newRotationOffset !== undefined ? empData.newRotationOffset : 'N/A';
                const workPattern = getWorkPattern(empId, empData.requirementId, empData.newRotationOffset) || [];
                const workPatternStr = workPattern.length > 0 ? `[${workPattern.join(' ‚Üí ')}]` : 'N/A';

                card.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h3 style="margin: 0;">${empId}</h3>
                        <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em; font-weight: 600;">#${index + 1}</span>
                    </div>
                    <div class="employee-stats">
                        <div class="stat-item">
                            <div class="label">Rotation Offset</div>
                            <div class="value" style="color: #667eea; font-weight: bold;">${rotationOffset}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Work Pattern</div>
                            <div class="value" style="font-size: 0.9em; color: #555;">${workPatternStr}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Total Normal Hours</div>
                            <div class="value">${weeklyHours.toFixed(1)}h</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Monthly OT (Total)</div>
                            <div class="value">${monthlyOt.toFixed(1)}h</div>
                            <div style="font-size: 0.8em; color: #999;">${monthlyOt <= 72 ? '‚úì OK' : '‚úó OVER'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Weekly Breakdown</div>
                            <div style="font-size: 0.9em; text-align: left;">
                                ${Object.entries(data.weekly_normal || {}).map(([week, hours]) =>
                                    `<div>${week}: ${hours.toFixed(1)}h ${hours <= 44 ? '‚úì' : '‚úó OVER'}</div>`
                                ).join('') || '<div style="color: #999;">No data</div>'}
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Monthly OT Breakdown</div>
                            <div style="font-size: 0.9em; text-align: left;">
                                ${Object.entries(data.monthly_ot || {}).map(([month, hours]) =>
                                    `<div>${month}: ${hours.toFixed(1)}h</div>`
                                ).join('') || '<div style="color: #999;">No OT</div>'}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderViolations() {
            const hard = outputData.scoreBreakdown?.hard?.violations || [];
            const softData = outputData.scoreBreakdown?.soft || {};
            const softDetails = softData.details || [];
            const container = document.getElementById('violationsContainer');
            container.innerHTML = '';

            if (hard.length === 0 && softDetails.length === 0) {
                container.innerHTML = '<div class="no-data success">‚úì No violations detected!</div>';
                return;
            }

            if (hard.length > 0) {
                const div = document.createElement('div');
                div.className = 'violations-list warning';
                div.innerHTML = `
                    <h4>‚ö†Ô∏è Hard Constraint Violations (${hard.length})</h4>
                    ${hard.map(v => `
                        <div class="violation-item">
                            <strong>${v.id || v.constraint || 'Unknown'}</strong>: ${v.note || v.message || 'No description'}
                        </div>
                    `).join('')}
                `;
                container.appendChild(div);
            }

            if (softDetails.length > 0) {
                const div = document.createElement('div');
                div.className = 'violations-list';
                div.innerHTML = `
                    <h4>üìå Soft Constraints (Total: ${softData.totalPenalty || 0} penalty)</h4>
                    ${softDetails.map(detail => `
                        <div class="violation-item">
                            <strong>${detail.constraint || detail.name || 'Unknown'}</strong>: ${detail.penalty || 0} penalty
                            ${detail.note || detail.message ? `<br><small>${detail.note || detail.message}</small>` : ''}
                        </div>
                    `).join('')}
                `;
                container.appendChild(div);
            }
        }

        // Timeline tab removed - functionality moved to calendar view in other tabs

        function renderCalendarView() {
            const assignments = outputData.assignments || [];

            if (assignments.length === 0) {
                document.getElementById('calendarContainer').innerHTML = '<div class="no-data">No assignments</div>';
                return;
            }

            // Detect new employees
            const newEmployeeIds = new Set();
            if (outputData.employeeChanges && outputData.employeeChanges.newJoiners) {
                outputData.employeeChanges.newJoiners.forEach(nj => {
                    newEmployeeIds.add(nj.employee.employeeId);
                });
            }

            // Group assignments by employee and date
            const assignmentsByEmployee = {};
            assignments.forEach(a => {
                if (!assignmentsByEmployee[a.employeeId]) {
                    assignmentsByEmployee[a.employeeId] = {};
                }
                assignmentsByEmployee[a.employeeId][a.date] = a;
            });

            // Get sorted dates and employees
            const allDates = [...new Set(assignments.map(a => a.date))].sort();
            const employees = Object.keys(assignmentsByEmployee).sort();

            // Group dates by month for better 3-month display
            const datesByMonth = {};
            allDates.forEach(date => {
                const month = date.substring(0, 7); // YYYY-MM
                if (!datesByMonth[month]) datesByMonth[month] = [];
                datesByMonth[month].push(date);
            });
            const months = Object.keys(datesByMonth).sort();
            
            // For large date ranges (> 31 days), show month-grouped view
            const isLongRange = allDates.length > 31;

            // Create calendar table with dates as columns
            let html = '<div class="calendar-grid" style="overflow-x: auto;">';
            
            if (isLongRange) {
                html += `<p style="margin-bottom: 15px; color: #667eea; font-weight: 600;">üìÖ Showing ${allDates.length} days across ${months.length} month(s): ${months.join(', ')}</p>`;
            }
            
            html += '<table class="calendar-table"><thead>';
            
            // Add month headers if multiple months
            if (isLongRange && months.length > 1) {
                html += '<tr><th class="calendar-date-header" rowspan="2" style="vertical-align: middle;">S.No</th>';
                html += '<th class="calendar-date-header" rowspan="2" style="vertical-align: middle;">Employee</th>';
                months.forEach(month => {
                    const monthDates = datesByMonth[month];
                    const monthName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    html += `<th colspan="${monthDates.length}" class="calendar-date-header" style="background: #667eea; color: white;">${monthName}</th>`;
                });
                html += '</tr><tr>';
                months.forEach(month => {
                    datesByMonth[month].forEach(date => {
                        const day = date.substring(8); // DD
                        html += `<th class="calendar-date-header" style="font-size: 0.85em;">${day}</th>`;
                    });
                });
                html += '</tr>';
            } else {
                html += '<tr><th class="calendar-date-header">S.No</th>';
                html += '<th class="calendar-date-header">Employee</th>';
                allDates.forEach(date => {
                    html += `<th class="calendar-date-header">${date}</th>`;
                });
                html += '</tr>';
            }
            html += '</thead><tbody>';

            html += '</tr></thead><tbody>';

            // Fill in employees (rows) and their assignments by date (columns)
            employees.forEach((emp, index) => {
                const isNewEmployee = newEmployeeIds.has(emp);
                const empBadge = isNewEmployee ? ' <span class="assignment-badge badge-new">‚ú® NEW</span>' : '';
                
                html += '<tr>';
                html += `<td class="calendar-date-header" style="text-align: center; font-weight: bold; color: #667eea;">${index + 1}</td>`;
                html += `<td class="calendar-date-header"><strong>${emp}</strong>${empBadge}</td>`;

                allDates.forEach(date => {
                    const assignment = assignmentsByEmployee[emp][date];

                    if (assignment) {
                        const start = new Date(assignment.startDateTime);
                        const end = new Date(assignment.endDateTime);
                        const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const normal = (assignment.hours?.normal || 0).toFixed(1);
                        const ot = (assignment.hours?.ot || 0).toFixed(1);
                        
                        // Determine source and apply styling
                        const auditInfo = assignment.auditInfo || {};
                        const source = auditInfo.source || '';
                        let cellClasses = 'assignment-cell';
                        if (source === 'locked') {
                            cellClasses += ' locked';
                        } else if (source === 'incremental') {
                            cellClasses += ' incremental';
                        }
                        if (isNewEmployee) {
                            cellClasses += ' new-employee';
                        }
                        
                        // Determine shift type for additional styling
                        const shiftCode = (assignment.shiftCode || '').toUpperCase();
                        
                        const reqInfo = assignment.requirementId ? `<br><span style="font-size: 0.85em; opacity: 0.8;">Req: ${assignment.requirementId}</span>` : '';
                        
                        // Create badge
                        let badge = '';
                        if (source === 'locked') {
                            badge = '<span class="assignment-badge badge-locked">üîí</span>';
                        } else if (source === 'incremental') {
                            badge = '<span class="assignment-badge badge-incremental">üîÑ</span>';
                        }

                        html += `<td>
                            <div class="${cellClasses}">
                                ${badge}
                                <span class="assignment-shift">${assignment.shiftCode} - ${assignment.demandId || 'N/A'}${reqInfo}</span>
                                <span class="assignment-hours">${startTime}‚Äì${endTime}</span>
                                <span class="assignment-hours">${normal}h N / ${ot}h OT</span>
                            </div>
                        </td>`;
                    } else {
                        html += `<td style="background: #f5f5f5;"><div class="assignment-cell-empty">‚Äî</div></td>`;
                    }
                });

                html += '</tr>';
            });

            html += '</tbody></table></div>';
            document.getElementById('calendarContainer').innerHTML = html;
        }

        // switchTimelineView removed - timeline tab no longer exists

        function renderEmptySlots() {
            const container = document.getElementById('emptySlotsContainer');
            
            if (!outputData || !outputData.assignments) {
                container.innerHTML = '<p style="color: #999;">No assignment data available</p>';
                return;
            }

            const assignments = outputData.assignments;
            
            // Get public holidays from output data
            const publicHolidays = new Set(outputData.publicHolidays || []);
            
            // Build a map of all demands and dates from assignments
            const demandMap = {};
            const allDatesSet = new Set();
            
            assignments.forEach(a => {
                if (!demandMap[a.demandId]) {
                    demandMap[a.demandId] = {
                        demandId: a.demandId,
                        requirements: {},  // v0.70: Group by requirement
                        assignments: []
                    };
                }
                demandMap[a.demandId].assignments.push(a);
                
                // Group by requirement ID (v0.70 schema)
                const reqId = a.requirementId || 'default';
                if (!demandMap[a.demandId].requirements[reqId]) {
                    demandMap[a.demandId].requirements[reqId] = [];
                }
                demandMap[a.demandId].requirements[reqId].push(a);
                
                allDatesSet.add(a.date);
            });

            // Generate complete date range including off days
            let allDates = Array.from(allDatesSet).sort();
            
            if (allDates.length === 0) {
                container.innerHTML = '<p style="color: #999;">No assignments found</p>';
                return;
            }
            
            // Expand date range to include all days between first and last assignment
            const firstDate = new Date(allDates[0]);
            const lastDate = new Date(allDates[allDates.length - 1]);
            const completeDateRange = [];
            for (let d = new Date(firstDate); d <= lastDate; d.setDate(d.getDate() + 1)) {
                completeDateRange.push(d.toISOString().split('T')[0]);
            }
            allDates = completeDateRange;

            // Build assignment map by demand and date
            const assignmentsByDemandDate = {};
            Object.keys(demandMap).forEach(demandId => {
                assignmentsByDemandDate[demandId] = {};
                demandMap[demandId].assignments.forEach(a => {
                    if (!assignmentsByDemandDate[demandId][a.date]) {
                        assignmentsByDemandDate[demandId][a.date] = [];
                    }
                    assignmentsByDemandDate[demandId][a.date].push(a);
                });
            });

            // Render calendar grid showing assignments by demand
            let html = '<div style="overflow-x: auto;">';
            html += `<p style="margin-bottom: 20px; color: #666; font-size: 1.1em;">
                <strong>Demand Coverage View</strong> - Shows which slots are filled for each demand
            </p>`;
            html += '<table style="border-collapse: collapse; width: 100%; min-width: 800px;">';
            
            // Header row with dates
            html += '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #f8f9fa; padding: 12px; border: 1px solid #ddd; min-width: 150px; z-index: 10;">Demand ID</th>';
            allDates.forEach(date => {
                const d = new Date(date);
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isPublicHoliday = publicHolidays.has(date);
                const headerBg = isPublicHoliday ? '#ffebee' : '#f8f9fa';
                const headerBorder = isPublicHoliday ? '2px solid #f44336' : '1px solid #ddd';
                html += `<th style="padding: 12px; border: ${headerBorder}; background: ${headerBg}; font-size: 0.85em; min-width: 140px;">
                    ${isPublicHoliday ? 'üéâ ' : ''}${dayName}<br>${dateStr}
                </th>`;
            });
            html += '</tr></thead><tbody>';

            // Rows for each demand (with requirements as sub-rows)
            Object.entries(assignmentsByDemandDate).forEach(([demandId, dateMap]) => {
                const demand = demandMap[demandId];
                const requirements = demand ? demand.requirements : {};
                const requirementIds = Object.keys(requirements);
                
                // If multiple requirements, show demand header + requirement rows
                if (requirementIds.length > 1) {
                    // Demand header row (spans all dates)
                    html += '<tr style="background: #e3f2fd;">';
                    html += `<td colspan="${allDates.length + 1}" style="padding: 8px 12px; border: 1px solid #ddd; font-weight: bold; font-size: 1.05em;">
                        üìã ${demandId} <span style="color: #666; font-weight: normal; font-size: 0.9em;">(${requirementIds.length} requirements)</span>
                    </td>`;
                    html += '</tr>';
                    
                    // Row for each requirement
                    requirementIds.forEach(reqId => {
                        html += '<tr>';
                        html += `<td style="position: sticky; left: 0; background: white; padding: 8px 12px 8px 24px; border: 1px solid #ddd; font-weight: 500; z-index: 5; font-size: 0.95em;">
                            ‚Ü≥ Req: ${reqId}
                        </td>`;
                        
                        allDates.forEach(date => {
                            const reqAssignments = requirements[reqId].filter(a => a.date === date);
                            const isPublicHoliday = publicHolidays.has(date);
                            html += renderAssignmentCell(reqAssignments, isPublicHoliday, date);
                        });
                        
                        html += '</tr>';
                    });
                } else {
                    // Single requirement or no requirement info - show as before
                    html += '<tr>';
                    html += `<td style="position: sticky; left: 0; background: white; padding: 12px; border: 1px solid #ddd; font-weight: bold; z-index: 5;">
                        ${demandId}
                    </td>`;

                    allDates.forEach(date => {
                        const assignments = dateMap[date] || [];
                        const isPublicHoliday = publicHolidays.has(date);
                        html += renderAssignmentCell(assignments, isPublicHoliday, date);
                    });

                    html += '</tr>';
                }
            });
            
            // Helper function to render assignment cells (extracted for reuse)
            function renderAssignmentCell(assignments, isPublicHoliday, date) {
                let cellHtml = '';
                
                if (assignments.length > 0) {
                    // Check if any assignment has no employee (unfilled slot)
                    const hasUnfilledSlot = assignments.some(a => !a.employeeId || a.employeeId === '' || a.employeeId === 'UNASSIGNED');
                    
                    // Determine cell background based on unfilled status
                    let cellBg, cellBorder;
                    if (hasUnfilledSlot) {
                        // Unfilled slot - use red background
                        cellBg = '#ffcdd2';
                        cellBorder = '2px solid #d32f2f';
                    } else if (isPublicHoliday) {
                        cellBg = '#ffebee';
                        cellBorder = '1px solid #f44336';
                    } else {
                        cellBg = '#e8f5e9';
                        cellBorder = '1px solid #ddd';
                    }
                    
                    cellHtml += `<td style="padding: 4px; border: ${cellBorder}; background: ${cellBg}; vertical-align: top;">`;
                    
                    assignments.forEach(assignment => {
                        // Check if this is an unfilled slot
                        if (!assignment.employeeId || assignment.employeeId === '' || assignment.employeeId === 'UNASSIGNED') {
                            // Unfilled slot - red background with warning
                            const reqId = assignment.requirementId || 'N/A';
                            const position = assignment.position !== undefined ? `P${assignment.position}` : 'N/A';
                            const reason = assignment.reason || 'No eligible employees';
                            cellHtml += `<div style="background: #d32f2f; color: white; padding: 6px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em; box-shadow: 0 2px 4px rgba(211,47,47,0.3);">
                                <div style="font-weight: bold;">‚ùå Pos ${position} - ${assignment.shiftCode || 'N/A'}</div>
                                <div style="margin-top: 2px; opacity: 0.95;">UNFILLED</div>
                                <div style="font-size: 0.75em; opacity: 0.9; margin-top: 2px;">${reason.substring(0, 50)}${reason.length > 50 ? '...' : ''}</div>
                            </div>`;
                        } else {
                            // Normal filled assignment
                            const start = new Date(assignment.startDateTime);
                            const end = new Date(assignment.endDateTime);
                            const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const normal = (assignment.hours?.normal || 0).toFixed(1);
                            const ot = (assignment.hours?.ot || 0).toFixed(1);
                            const reqId = assignment.requirementId || 'N/A';
                            const position = assignment.position !== undefined ? `P${assignment.position}` : '';
                            
                            // Determine shift type for color coding
                            let cellStyle = 'background: #c8e6c9; border-left: 4px solid #4caf50;'; // Green for filled
                            const shiftCode = (assignment.shiftCode || '').toUpperCase();
                            if (shiftCode.includes('D')) {
                                cellStyle = 'background: #e3f2fd; border-left: 4px solid #2196f3;'; // Blue for day
                            } else if (shiftCode.includes('N')) {
                                cellStyle = 'background: #e8eaf6; border-left: 4px solid #3f51b5;'; // Indigo for night
                            }
                            
                            cellHtml += `<div style="${cellStyle} padding: 6px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em;">
                                <div style="font-weight: bold; color: #2e7d32;">‚úì ${position ? position + ' - ' : ''}${assignment.shiftCode}</div>
                                <div style="color: #1565c0; font-weight: 600; margin-top: 2px;">${assignment.employeeId}</div>
                                <div style="color: #555; margin-top: 2px;">${startTime}‚Äì${endTime}</div>
                                <div style="color: #666; font-size: 0.9em;">${normal}h N / ${ot}h OT</div>
                            </div>`;
                        }
                    });
                    
                    cellHtml += '</td>';
                } else {
                    // No assignment for this demand/requirement on this date
                    // Note: If includePublicHolidays=true, slots SHOULD exist and be filled
                    // This display just indicates no assignment data, not necessarily "Holiday off"
                    const cellBg = isPublicHoliday ? '#fff3e0' : '#f5f5f5';
                    const cellBorder = isPublicHoliday ? '1px solid #ff9800' : '1px solid #ddd';
                    cellHtml += `<td style="padding: 8px; border: ${cellBorder}; background: ${cellBg}; text-align: center; vertical-align: middle;">`;
                    
                    // Display appropriately - public holiday marking is for visual reference only
                    // The actual slot creation depends on includePublicHolidays in input
                    cellHtml += `<div style="color: #999; font-size: 0.9em; font-weight: 500;">${isPublicHoliday ? 'üéâ' : 'O'}</div>`;
                    if (isPublicHoliday) {
                        cellHtml += '<div style="color: #f57c00; font-size: 0.75em; margin-top: 2px;">PH</div>';
                    } else {
                        cellHtml += '<div style="color: #bbb; font-size: 0.75em; margin-top: 2px;">Off</div>';
                    }
                    cellHtml += '</td>';
                }
                
                return cellHtml;
            }

            html += '</tbody></table></div>';
            html += `<p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <strong>‚ÑπÔ∏è Understanding the Display:</strong><br>
                ‚Ä¢ Cells with filled assignments show employee details<br>
                ‚Ä¢ Empty cells with üéâ mark public holidays from the input (visual reference only)<br>
                ‚Ä¢ <strong>Important:</strong> If <code>includePublicHolidays=true</code> in input, slots ARE created for public holidays and should be filled. 
                  Check for red UNFILLED warnings on those dates.<br>
                ‚Ä¢ If <code>includePublicHolidays=false</code>, no slots are created on public holidays (no coverage needed).
            </p>`;
            container.innerHTML = html;
        }

        function renderEmployeeRoster() {
            const container = document.getElementById('employeeRosterContainer');
            
            if (!outputData || !outputData.assignments) {
                container.innerHTML = '<p style="color: #999;">No assignment data available</p>';
                return;
            }

            // Check if new employeeRoster section is available (schema v0.43+)
            const hasEmployeeRoster = outputData.employeeRoster && Array.isArray(outputData.employeeRoster);
            
            if (hasEmployeeRoster) {
                // Use new employeeRoster section for accurate status information
                renderEmployeeRosterNew(container);
            } else {
                // Fallback to old calculation method
                renderEmployeeRosterLegacy(container);
            }
        }

        function renderEmployeeRosterNew(container) {
            // NEW: Use employeeRoster section from output JSON
            const employeeRoster = outputData.employeeRoster;
            const publicHolidays = new Set(outputData.publicHolidays || []);
            
            if (employeeRoster.length === 0) {
                container.innerHTML = '<p style="color: #999;">No employee roster data available</p>';
                return;
            }
            
            // Get all dates from first employee's dailyStatus
            const allDates = employeeRoster[0].dailyStatus.map(d => d.date);
            
            // Build assignment map for quick lookup (for displaying assignment details)
            const assignmentsByEmployeeDate = {};
            outputData.assignments.forEach(a => {
                const empId = a.employeeId;
                if (!assignmentsByEmployeeDate[empId]) {
                    assignmentsByEmployeeDate[empId] = {};
                }
                if (!assignmentsByEmployeeDate[empId][a.date]) {
                    assignmentsByEmployeeDate[empId][a.date] = [];
                }
                assignmentsByEmployeeDate[empId][a.date].push(a);
            });
            
            // Calculate totals for each employee
            const employeeTotals = {};
            employeeRoster.forEach(emp => {
                const empId = emp.employeeId;
                const empAssignments = assignmentsByEmployeeDate[empId] || {};
                let normalTotal = 0, otTotal = 0;
                Object.values(empAssignments).flat().forEach(a => {
                    normalTotal += a.hours?.normal || 0;
                    otTotal += a.hours?.ot || 0;
                });
                employeeTotals[empId] = { normal: normalTotal, ot: otTotal };
            });
            
            // Render table header
            let html = '<div style="overflow-x: auto; max-width: 100%;"><table style="border-collapse: collapse; width: 100%; min-width: 1000px;">';
            html += '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #e3f2fd; padding: 12px; border: 1px solid #ddd; min-width: 150px; z-index: 11; font-weight: bold;">Employee</th>';
            
            allDates.forEach(date => {
                const d = new Date(date);
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isPublicHoliday = publicHolidays.has(date);
                html += `<th style="padding: 12px; border: 1px solid #ddd; min-width: 120px; text-align: center; ${isPublicHoliday ? 'background: #ffebee; color: #d32f2f;' : 'background: #f5f5f5;'}">
                    ${isPublicHoliday ? 'üéâ ' : ''}${dayName}<br>${dateStr}
                </th>`;
            });
            html += '<th style="position: sticky; right: 0; background: #e3f2fd; padding: 12px; border: 1px solid #ddd; min-width: 120px; z-index: 10; font-weight: bold;">Total Hours</th>';
            html += '</tr></thead><tbody>';
            
            // Separate used and unused employees
            const usedEmployees = employeeRoster.filter(e => e.assignedDays > 0);
            const unusedEmployees = employeeRoster.filter(e => e.assignedDays === 0);
            
            // Sort used employees by offset, then by ID
            const sortedUsedEmployees = [...usedEmployees].sort((a, b) => {
                if (a.rotationOffset !== b.rotationOffset) {
                    return a.rotationOffset - b.rotationOffset;
                }
                return a.employeeId.localeCompare(b.employeeId);
            });
            
            // Sort unused employees by ID
            const sortedUnusedEmployees = [...unusedEmployees].sort((a, b) => 
                a.employeeId.localeCompare(b.employeeId)
            );
            
            // Render used employees first
            sortedUsedEmployees.forEach(emp => {
                const empId = emp.employeeId;
                const empOffset = emp.rotationOffset;
                const empPattern = emp.workPattern;
                const totals = employeeTotals[empId] || { normal: 0, ot: 0 };
                
                let patternDisplay = '-';
                if (empPattern && Array.isArray(empPattern)) {
                    patternDisplay = empPattern.join('-');
                }
                
                html += '<tr>';
                html += `<td style="position: sticky; left: 0; background: white; padding: 12px; border: 1px solid #ddd; font-weight: bold; z-index: 5;">
                    <div style="font-size: 1em;">${empId}</div>
                    <div style="font-size: 0.85em; color: #666; font-weight: normal; margin-top: 4px;">Offset: ${empOffset}</div>
                    <div style="font-size: 0.8em; color: #2196f3; font-weight: normal; margin-top: 2px;">${patternDisplay}</div>
                </td>`;
                
                // Render each day's status
                emp.dailyStatus.forEach(dayStatus => {
                    const date = dayStatus.date;
                    const status = dayStatus.status;
                    const isPublicHoliday = publicHolidays.has(date);
                    const assignments = (assignmentsByEmployeeDate[empId] || {})[date] || [];
                    
                    if (status === 'ASSIGNED' && assignments.length > 0) {
                        // Show assignment details
                        const cellBg = isPublicHoliday ? '#ffebee' : '#e8f5e9';
                        const cellBorder = isPublicHoliday ? '1px solid #f44336' : '1px solid #ddd';
                        
                        html += `<td style="padding: 4px; border: ${cellBorder}; background: ${cellBg}; vertical-align: top;">`;
                        
                        assignments.forEach(assignment => {
                            const start = new Date(assignment.startDateTime);
                            const end = new Date(assignment.endDateTime);
                            const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const normal = (assignment.hours?.normal || 0).toFixed(1);
                            const ot = (assignment.hours?.ot || 0).toFixed(1);
                            
                            let cellStyle = 'background: #c8e6c9; border-left: 4px solid #4caf50;';
                            const shiftCode = (assignment.shiftCode || '').toUpperCase();
                            if (shiftCode.includes('D')) {
                                cellStyle = 'background: #e3f2fd; border-left: 4px solid #2196f3;';
                            } else if (shiftCode.includes('N')) {
                                cellStyle = 'background: #e8eaf6; border-left: 4px solid #3f51b5;';
                            }
                            
                            const reqId = assignment.requirementId || 'N/A';
                            const rotOffset = assignment.newRotationOffset !== undefined ? assignment.newRotationOffset : '-';
                            html += `<div style="${cellStyle} padding: 6px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em;">
                                <div style="font-weight: bold; color: #2e7d32;">Req:${reqId}, ${assignment.shiftCode} <span style="color: #888; font-size: 0.9em;">(R${rotOffset})</span></div>
                                <div style="color: #555; margin-top: 2px;">${startTime}‚Äì${endTime}</div>
                                <div style="color: #666; font-size: 0.9em;">${normal}h N${ot > 0 ? ` / ${ot}h OT` : ''}</div>
                            </div>`;
                        });
                        html += '</td>';
                    } else {
                        // No assignment - use status from employeeRoster
                        let cellBg, cellBorder, displayText, subText, textColor;
                        
                        if (status === 'OFF_DAY') {
                            cellBg = isPublicHoliday ? '#fff3e0' : '#f5f5f5';
                            cellBorder = isPublicHoliday ? '1px solid #ff9800' : '1px solid #ddd';
                            displayText = isPublicHoliday ? 'üéâ' : 'O';
                            subText = isPublicHoliday ? 'Holiday' : 'Off Day';
                            textColor = '#999';
                        } else if (status === 'UNASSIGNED') {
                            cellBg = '#fff9c4';
                            cellBorder = '2px solid #fbc02d';
                            displayText = '‚ö†';
                            subText = `Unassigned${dayStatus.expectedShift ? ` (${dayStatus.expectedShift})` : ''}`;
                            textColor = '#f57f17';
                        } else if (status === 'NOT_USED') {
                            cellBg = '#ffebee';
                            cellBorder = '1px solid #ef5350';
                            displayText = '‚Äî';
                            subText = 'Not Used';
                            textColor = '#c62828';
                        } else {
                            // Unknown status
                            cellBg = '#fafafa';
                            cellBorder = '1px solid #ddd';
                            displayText = '?';
                            subText = status || 'Unknown';
                            textColor = '#666';
                        }
                        
                        html += `<td style="padding: 8px; border: ${cellBorder}; background: ${cellBg}; text-align: center; vertical-align: middle;">`;
                        html += `<div style="color: ${textColor}; font-size: 0.9em; font-weight: 500;">${displayText}</div>`;
                        html += `<div style="color: ${textColor}; font-size: 0.75em; margin-top: 2px;">${subText}</div>`;
                        html += '</td>';
                    }
                });
                
                // Add totals column
                html += `<td style="position: sticky; right: 0; background: #e3f2fd; padding: 12px; border: 1px solid #ddd; z-index: 5; text-align: center;">`;
                html += `<div style="font-weight: bold; color: #1565c0; font-size: 0.95em;">${totals.normal.toFixed(1)}h N</div>`;
                if (totals.ot > 0) {
                    html += `<div style="font-weight: bold; color: #d32f2f; font-size: 0.95em; margin-top: 4px;">${totals.ot.toFixed(1)}h OT</div>`;
                }
                html += '</td>';
                html += '</tr>';
            });
            
            // Add separator row if there are unused employees
            if (sortedUnusedEmployees.length > 0) {
                html += `<tr style="background: #fafafa; border-top: 3px solid #e0e0e0; border-bottom: 3px solid #e0e0e0;">
                    <td colspan="${allDates.length + 2}" style="padding: 12px; text-align: center; font-weight: bold; color: #666; font-size: 0.95em;">
                        ‚ö†Ô∏è UNUSED EMPLOYEES (${sortedUnusedEmployees.length}) - Not assigned any shifts
                    </td>
                </tr>`;
                
                // Render unused employees
                sortedUnusedEmployees.forEach(emp => {
                    const empId = emp.employeeId;
                    const empOffset = emp.rotationOffset;
                    const empPattern = emp.workPattern;
                    const totals = employeeTotals[empId] || { normal: 0, ot: 0 };
                    
                    let patternDisplay = '-';
                    if (empPattern && Array.isArray(empPattern)) {
                        patternDisplay = empPattern.join('-');
                    }
                    
                    html += '<tr style="background: #fff8f8;">';
                    html += `<td style="position: sticky; left: 0; background: #fff8f8; padding: 12px; border: 1px solid #ddd; font-weight: bold; z-index: 5;">
                        <div style="font-size: 1em; color: #c62828;">${empId}</div>
                        <div style="font-size: 0.85em; color: #999; font-weight: normal; margin-top: 4px;">Offset: ${empOffset}</div>
                        <div style="font-size: 0.8em; color: #999; font-weight: normal; margin-top: 2px;">${patternDisplay}</div>
                    </td>`;
                    
                    // Render each day as "Not Used"
                    emp.dailyStatus.forEach(dayStatus => {
                        const date = dayStatus.date;
                        const isPublicHoliday = publicHolidays.has(date);
                        
                        const cellBg = '#ffebee';
                        const cellBorder = '1px solid #ef5350';
                        const displayText = '‚Äî';
                        const subText = 'Not Used';
                        const textColor = '#c62828';
                        
                        html += `<td style="padding: 8px; border: ${cellBorder}; background: ${cellBg}; text-align: center; vertical-align: middle;">`;
                        html += `<div style="color: ${textColor}; font-size: 0.9em; font-weight: 500;">${displayText}</div>`;
                        html += `<div style="color: ${textColor}; font-size: 0.75em; margin-top: 2px;">${subText}</div>`;
                        html += '</td>';
                    });
                    
                    // Add totals column (all zeros for unused employees)
                    html += `<td style="position: sticky; right: 0; background: #ffebee; padding: 12px; border: 1px solid #ddd; z-index: 5; text-align: center;">`;
                    html += `<div style="font-weight: bold; color: #999; font-size: 0.95em;">0h</div>`;
                    html += '</td>';
                    html += '</tr>';
                });
            }
            
            html += '</tbody></table></div>';
            html += `<p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <strong>‚ÑπÔ∏è Summary:</strong> 
                ${usedEmployees.length} employees actively used, ${unusedEmployees.length} employees not assigned<br>
                <strong>Legend:</strong> 
                <span style="background: #e3f2fd; padding: 4px 8px; border-left: 4px solid #2196f3; margin: 0 8px;">D = Day Shift</span>
                <span style="background: #e8eaf6; padding: 4px 8px; border-left: 4px solid #3f51b5; margin: 0 8px;">N = Night Shift</span>
                <span style="color: #999; margin: 0 8px;">O = Off Day</span>
                <span style="color: #f57f17; margin: 0 8px;">‚ö† = Unassigned (should work)</span>
                <span style="color: #c62828; margin: 0 8px;">‚Äî = Not Used</span>
                <span style="color: #f57c00; margin: 0 8px;">üéâ = Public Holiday</span>
            </p>`;
            container.innerHTML = html;
        }

        function renderEmployeeRosterLegacy(container) {
            // LEGACY: Calculate status from assignments (for older output format)
            const assignments = outputData.assignments;
            const publicHolidays = new Set(outputData.publicHolidays || []);
            
            // Group assignments by employee
            const assignmentsByEmployee = {};
            const allDatesSet = new Set();
            
            assignments.forEach(a => {
                const empId = a.employeeId || 'UNASSIGNED';
                if (!assignmentsByEmployee[empId]) {
                    assignmentsByEmployee[empId] = [];
                }
                assignmentsByEmployee[empId].push(a);
                allDatesSet.add(a.date);
            });

            // Generate complete date range including off days
            let allDates = Array.from(allDatesSet).sort();
            
            if (allDates.length === 0) {
                container.innerHTML = '<p style="color: #999;">No assignments found</p>';
                return;
            }
            
            // Expand date range to include all days between first and last assignment
            const firstDate = new Date(allDates[0]);
            const lastDate = new Date(allDates[allDates.length - 1]);
            const completeDateRange = [];
            for (let d = new Date(firstDate); d <= lastDate; d.setDate(d.getDate() + 1)) {
                completeDateRange.push(d.toISOString().split('T')[0]);
            }
            allDates = completeDateRange;

            // Build assignment map by employee and date
            // Also extract newRotationOffset and workPattern for each employee (take from first assignment)
            const assignmentsByEmployeeDate = {};
            const employeeInfo = {}; // Store employeeId -> {newRotationOffset, workPattern, employeeId}
            Object.keys(assignmentsByEmployee).forEach(empId => {
                assignmentsByEmployeeDate[empId] = {};
                const firstAssignment = assignmentsByEmployee[empId][0];
                employeeInfo[empId] = {
                    employeeId: empId,
                    newRotationOffset: firstAssignment?.newRotationOffset !== undefined ? firstAssignment.newRotationOffset : 0,
                    workPattern: firstAssignment?.workPattern || null
                };
                assignmentsByEmployee[empId].forEach(a => {
                    if (!assignmentsByEmployeeDate[empId][a.date]) {
                        assignmentsByEmployeeDate[empId][a.date] = [];
                    }
                    assignmentsByEmployeeDate[empId][a.date].push(a);
                });
            });

            // Calculate totals for each employee
            const employeeTotals = {};
            Object.entries(assignmentsByEmployee).forEach(([empId, empAssignments]) => {
                let totalNormal = 0;
                let totalOT = 0;
                empAssignments.forEach(a => {
                    totalNormal += (a.hours?.normal || 0);
                    totalOT += (a.hours?.ot || 0);
                });
                employeeTotals[empId] = { normal: totalNormal, ot: totalOT };
            });

            // Render calendar grid showing assignments by employee
            let html = '<div style="overflow-x: auto;">';
            html += `<p style="margin-bottom: 20px; color: #666; font-size: 1.1em;">
                <strong>Employee Roster View</strong> - Shows each employee's assignments, off days, and total hours
            </p>`;
            
            // Add legend
            html += `<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                <strong style="color: #495057; font-size: 0.95em;">Legend:</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 30px; background: #e8f5e9; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 0.8em; border-radius: 3px;">D/N</div>
                        <span style="color: #666; font-size: 0.85em;">Assigned Shift</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 30px; background: #f5f5f5; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 0.8em; border-radius: 3px;">O</div>
                        <span style="color: #666; font-size: 0.85em;">Off Day (Pattern)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 30px; background: #fff9c4; border: 2px solid #fbc02d; display: flex; align-items: center; justify-content: center; font-size: 0.8em; border-radius: 3px;">‚ö†</div>
                        <span style="color: #666; font-size: 0.85em;">Unassigned (Expected Work)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 30px; background: #ffebee; border: 1px solid #ef5350; display: flex; align-items: center; justify-content: center; font-size: 0.8em; border-radius: 3px;">‚Äî</div>
                        <span style="color: #666; font-size: 0.85em;">Employee Not Used</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 30px; height: 30px; background: #fff3e0; border: 1px solid #ff9800; display: flex; align-items: center; justify-content: center; font-size: 0.8em; border-radius: 3px;">üéâ</div>
                        <span style="color: #666; font-size: 0.85em;">Public Holiday</span>
                    </div>
                </div>
            </div>`;
            
            html += '<table style="border-collapse: collapse; width: 100%; min-width: 800px;">';
            
            // Header row with dates
            html += '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #f8f9fa; padding: 12px; border: 1px solid #ddd; min-width: 150px; z-index: 10;">Employee ID<br><span style="font-size: 0.8em; font-weight: normal; color: #666;">(Rotation Offset)</span></th>';
            allDates.forEach(date => {
                const d = new Date(date);
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isPublicHoliday = publicHolidays.has(date);
                const headerBg = isPublicHoliday ? '#ffebee' : '#f8f9fa';
                const headerBorder = isPublicHoliday ? '2px solid #f44336' : '1px solid #ddd';
                html += `<th style="padding: 12px; border: ${headerBorder}; background: ${headerBg}; font-size: 0.85em; min-width: 140px;">
                    ${isPublicHoliday ? 'üéâ ' : ''}${dayName}<br>${dateStr}
                </th>`;
            });
            html += '<th style="position: sticky; right: 0; background: #e3f2fd; padding: 12px; border: 1px solid #ddd; min-width: 120px; z-index: 10; font-weight: bold;">Total Hours</th>';
            html += '</tr></thead><tbody>';

            // Rows for each employee - sort by newRotationOffset (primary), then employeeId (secondary)
            const sortedEmployees = Object.keys(assignmentsByEmployeeDate).sort((a, b) => {
                const offsetA = employeeInfo[a].newRotationOffset;
                const offsetB = employeeInfo[b].newRotationOffset;
                if (offsetA !== offsetB) {
                    return offsetA - offsetB; // Sort by offset ascending
                }
                return a.localeCompare(b); // Then by employee ID
            });
            
            sortedEmployees.forEach(empId => {
                const dateMap = assignmentsByEmployeeDate[empId];
                const totals = employeeTotals[empId];
                const empOffset = employeeInfo[empId].newRotationOffset;
                const empPattern = employeeInfo[empId].workPattern;
                
                // The workPattern already represents how the pattern appears for this employee
                // Display it as-is
                let patternDisplay = '-';
                if (empPattern && Array.isArray(empPattern)) {
                    patternDisplay = empPattern.join('-');
                }
                
                html += '<tr>';
                html += `<td style="position: sticky; left: 0; background: white; padding: 12px; border: 1px solid #ddd; font-weight: bold; z-index: 5;">
                    <div style="font-size: 1em;">${empId}</div>
                    <div style="font-size: 0.85em; color: #666; font-weight: normal; margin-top: 4px;">Offset: ${empOffset}</div>
                    <div style="font-size: 0.8em; color: #2196f3; font-weight: normal; margin-top: 2px;">${patternDisplay}</div>
                </td>`;

                allDates.forEach((date, dateIndex) => {
                    const assignments = dateMap[date] || [];
                    const isPublicHoliday = publicHolidays.has(date);
                    
                    // Calculate expected shift for this employee on this date based on their pattern
                    let expectedShift = null;
                    let isPatternOffDay = false;
                    if (empPattern && Array.isArray(empPattern) && empPattern.length > 0) {
                        // Calculate which position in the pattern this date corresponds to
                        const patternLength = empPattern.length;
                        const cyclePosition = dateIndex % patternLength;
                        expectedShift = empPattern[cyclePosition];
                        isPatternOffDay = (expectedShift === 'O');
                    }
                    
                    if (assignments.length > 0) {
                        // Show filled assignments
                        const hasUnfilledSlot = assignments.some(a => !a.employeeId || a.employeeId === '' || a.employeeId === 'UNASSIGNED');
                        
                        let cellBg, cellBorder;
                        if (hasUnfilledSlot) {
                            cellBg = '#ffcdd2';
                            cellBorder = '2px solid #d32f2f';
                        } else if (isPublicHoliday) {
                            cellBg = '#ffebee';
                            cellBorder = '1px solid #f44336';
                        } else {
                            cellBg = '#e8f5e9';
                            cellBorder = '1px solid #ddd';
                        }
                        
                        html += `<td style="padding: 4px; border: ${cellBorder}; background: ${cellBg}; vertical-align: top;">`;
                        
                        assignments.forEach(assignment => {
                            const start = new Date(assignment.startDateTime);
                            const end = new Date(assignment.endDateTime);
                            const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const normal = (assignment.hours?.normal || 0).toFixed(1);
                            const ot = (assignment.hours?.ot || 0).toFixed(1);
                            
                            // Determine shift type for color coding
                            let cellStyle = 'background: #c8e6c9; border-left: 4px solid #4caf50;';
                            const shiftCode = (assignment.shiftCode || '').toUpperCase();
                            if (shiftCode.includes('D')) {
                                cellStyle = 'background: #e3f2fd; border-left: 4px solid #2196f3;';
                            } else if (shiftCode.includes('N')) {
                                cellStyle = 'background: #e8eaf6; border-left: 4px solid #3f51b5;';
                            }
                            
                            const reqId = assignment.requirementId || 'N/A';
                            const rotOffset = assignment.newRotationOffset !== undefined ? assignment.newRotationOffset : '-';
                            html += `<div style="${cellStyle} padding: 6px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85em;">
                                <div style="font-weight: bold; color: #2e7d32;">Req:${reqId}, ${assignment.shiftCode} <span style="color: #888; font-size: 0.9em;">(R${rotOffset})</span></div>
                                <div style="color: #555; margin-top: 2px;">${startTime}‚Äì${endTime}</div>
                                <div style="color: #666; font-size: 0.9em;">${normal}h N${ot > 0 ? ` / ${ot}h OT` : ''}</div>
                            </div>`;
                        });
                        
                        html += '</td>';
                    } else {
                        // No assignment for this employee on this date
                        // Distinguish between: Off Day (pattern 'O'), Unassigned (could have worked), or Unused Employee
                        let cellBg, cellBorder, displayText, subText, textColor;
                        
                        if (isPatternOffDay) {
                            // Legitimate off-day according to work pattern
                            cellBg = isPublicHoliday ? '#fff3e0' : '#f5f5f5';
                            cellBorder = isPublicHoliday ? '1px solid #ff9800' : '1px solid #ddd';
                            displayText = isPublicHoliday ? 'üéâ' : 'O';
                            subText = isPublicHoliday ? 'Holiday' : 'Off Day';
                            textColor = '#999';
                        } else if (empPattern && empPattern.length > 0) {
                            // Employee has a pattern but wasn't assigned (should have worked this day)
                            cellBg = '#fff9c4';
                            cellBorder = '2px solid #fbc02d';
                            displayText = '‚ö†';
                            subText = `Unassigned (Expected: ${expectedShift || '?'})`;
                            textColor = '#f57f17';
                        } else {
                            // Employee has no pattern (completely unused)
                            cellBg = '#ffebee';
                            cellBorder = '1px solid #ef5350';
                            displayText = '‚Äî';
                            subText = 'Not Used';
                            textColor = '#c62828';
                        }
                        
                        html += `<td style="padding: 8px; border: ${cellBorder}; background: ${cellBg}; text-align: center; vertical-align: middle;">`;
                        html += `<div style="color: ${textColor}; font-size: 0.9em; font-weight: 500;">${displayText}</div>`;
                        html += `<div style="color: ${textColor}; font-size: 0.75em; margin-top: 2px;">${subText}</div>`;
                        html += '</td>';
                    }
                });
                
                // Add totals column
                html += `<td style="position: sticky; right: 0; background: #e3f2fd; padding: 12px; border: 1px solid #ddd; z-index: 5; text-align: center;">`;
                html += `<div style="font-weight: bold; color: #1565c0; font-size: 0.95em;">${totals.normal.toFixed(1)}h N</div>`;
                if (totals.ot > 0) {
                    html += `<div style="font-weight: bold; color: #d32f2f; font-size: 0.95em; margin-top: 4px;">${totals.ot.toFixed(1)}h OT</div>`;
                }
                html += '</td>';

                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            html += `<p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <strong>‚ÑπÔ∏è Legend:</strong> 
                <span style="background: #e3f2fd; padding: 4px 8px; border-left: 4px solid #2196f3; margin: 0 8px;">D = Day Shift</span>
                <span style="background: #e8eaf6; padding: 4px 8px; border-left: 4px solid #3f51b5; margin: 0 8px;">N = Night Shift</span>
                <span style="color: #999; margin: 0 8px;">O = Off Day</span>
                <span style="color: #f57c00; margin: 0 8px;">üéâ = Public Holiday</span>
            </p>`;
            container.innerHTML = html;
        }

        function renderMetadata() {
            const meta = outputData.meta || {};
            const solverRun = outputData.solverRun || {};

            const container = document.getElementById('metadataContainer');
            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Schema Version</span>
                    <span class="info-value">${outputData.schemaVersion || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Solver Version</span>
                    <span class="info-value">${solverRun.solverVersion || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status</span>
                    <span class="info-value">${solverRun.status || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Started</span>
                    <span class="info-value">${new Date(solverRun.startedAt).toLocaleString() || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ended</span>
                    <span class="info-value">${new Date(solverRun.ended).toLocaleString() || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Duration</span>
                    <span class="info-value">${solverRun.durationSeconds?.toFixed(3)}s</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Input Hash</span>
                    <span class="info-value" style="font-family: monospace; font-size: 0.9em;">${meta.inputHash || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Generated</span>
                    <span class="info-value">${new Date(meta.generatedAt).toLocaleString() || '-'}</span>
                </div>
            `;
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Highlight the button that was clicked
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
        }

        function clearFilters() {
            document.getElementById('employeeFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filterAssignments();
        }

        function filterAssignments() {
            const empId = document.getElementById('employeeFilter').value.toUpperCase();
            const date = document.getElementById('dateFilter').value;

            const tbody = document.getElementById('assignmentsBody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowEmpId = cells[1].textContent.toUpperCase();
                const rowDate = cells[0].textContent;

                const empMatch = !empId || rowEmpId.includes(empId);
                const dateMatch = !date || rowDate === date;

                row.style.display = empMatch && dateMatch ? '' : 'none';
            });
        }

        document.getElementById('employeeFilter')?.addEventListener('keyup', filterAssignments);
        document.getElementById('dateFilter')?.addEventListener('change', filterAssignments);
    </script>
</body>
</html>
